<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ text.title }} | {{ current_page }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* =========================================
           1. CORE STYLES
           ========================================= */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f0f4f7; color: #333; }
        .wrapper { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background-color: #2c3e50; color: white; box-shadow: 4px 0 10px rgba(0,0,0,0.2); flex-shrink: 0; display: flex; flex-direction: column; }
        .main-content { flex-grow: 1; padding: 30px; background-color: #f7f7f7; position: relative; }
        .sidebar-header { padding: 20px; text-align: center; font-size: 1.5em; font-weight: bold; background-color: #1a252f; }
        
        /* Sidebar Link Styling */
        .nav-item { display: block; padding: 15px 20px; font-size: 1.1em; text-decoration: none; color: #ccc; transition: background-color 0.2s, color 0.2s; }
        .nav-item:hover { background-color: #34495e; color: white; }
        .nav-item.active { background-color: #1abc9c; color: white; font-weight: bold; border-left: 5px solid #1abc9c; padding-left: 15px; }

        /* Icon Styling */
        .icon { width: 18px; height: 18px; margin-right: 10px; display: inline-block; vertical-align: middle; }

        /* Page Content Styles */
        .page-container { 
            background: white; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
            max-width: 1100px; 
            margin: 0 auto;    
        }
        
        .content-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 25px; 
            margin-top: 20px; 
        }
        .content-section { padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.06); }

        /* Input Form Styles */
        .input-form { background-color: #e8f5e9; border: 1px solid #c8e6c9; }
        label { display: block; margin-top: 15px; font-weight: 600; color: #388e3c; font-size: 1.1em; }
        input[type="number"], input[type="text"], input[type="password"], input[type="email"], select { 
            width: 100%; 
            padding: 14px; 
            margin-top: 8px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1.05em;
        }
        
        /* GLOBAL BUTTON STYLES */
        button { 
            background-color: #4CAF50; color: white; 
            padding: 16px 24px; 
            border: none; border-radius: 6px; cursor: pointer; margin-top: 25px; 
            width: 100%; 
            font-size: 1.2em; 
            font-weight: 600;
            transition: transform 0.1s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        button:hover { background-color: #388e3c; transform: translateY(-1px); }
        
        /* Highlighted Buttons Specifics */
        .recommend-btn { background-color: #008000 !important; box-shadow: 0 4px 10px rgba(0, 128, 0, 0.4); }
        .recommend-btn:hover { background-color: #006400 !important; }
        
        .detect-btn { background-color: #ff9800 !important; box-shadow: 0 4px 10px rgba(255, 152, 0, 0.4); }
        .detect-btn:hover { background-color: #f57c00 !important; }
        
        /* Results Styles */
        .results-section { background-color: #fff9c4; border: 1px solid #ffecb3; }
        .result-item { padding: 12px 0; border-bottom: 1px dashed #ccc; font-size: 1.1em; }
        .result-item:last-child { border-bottom: none; }
        .result-value { font-size: 1.2em; font-weight: bold; color: #f57c00; }
        .crop-value { font-size: 1.4em; font-weight: bold; color: #00796b; }
        .placeholder-box { padding: 20px; border-radius: 6px; margin-top: 20px; font-size: 1em; }

        /* Special Page Styles */
        .special-page { text-align: center; padding: 50px; background-color: #ecf0f1; border-radius: 8px; }
        .special-page h2 { color: #34495e; }

        /* Alert Styling */
        .alert-box { padding: 20px; margin-bottom: 25px; border-radius: 8px; font-weight: bold; font-size: 1.1em; }
        .alert-high { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-medium { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .alert-low { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }

        /* Table Styling */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 12px; text-align: left; font-size: 1em; }
        .data-table th { background-color: #f2f2f2; font-weight: 600; color: #555; }
        
        /* Map Styles */
        .field-label { font-size: 1em; font-weight: bold; color: #444; margin-bottom: 5px; }
        .field-value { font-size: 1.3em; font-weight: 600; color: #00796b; }
        .zone-info { padding: 10px; border-radius: 4px; margin-top: 10px; }

        /* Custom Button for Anchor Tag Styling */
        .report-link {
            display: inline-block; text-align: center; text-decoration: none; background-color: #1565c0; color: white;
            padding: 16px 24px; border-radius: 6px; cursor: pointer; margin-top: 20px; width: 100%; font-weight: bold; font-size: 1.1em;
        }
        .report-link:hover { background-color: #0d47a1; }

        /* Dashboard specific weather card styling (COMPACT) */
        .dashboard-weather-card {
            background-color: #e3f2fd; border: 1px solid #90caf9; padding: 15px; border-radius: 10px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1); color: #333; min-height: 90px;
        }
        .dashboard-weather-icon {
            font-size: 2em; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%;
        }
        .dashboard-weather-card .text-right p { font-size: 2rem; line-height: 1; }
        .dashboard-weather-card .text-right div { margin-top: 5px !important; }

        /* LIVE LOCATION STYLES */
        .live-weather-card { background-color: #2c3e50; color: white; border-radius: 10px; padding: 25px; margin-bottom: 25px; }
        .live-weather-card h2 { font-size: 2em; margin-bottom: 15px; color: #1abc9c; }
        .live-weather-card .temp-icon { font-size: 3em; line-height: 1; }
        .live-weather-card .detail-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 15px; text-align: center; }
        .detail-item strong { display: block; font-size: 1.8em; color: #f1c40f; }
        .detail-item span { font-size: 1em; color: #ccc; }
        
        .forecast-card { background-color: #ecf0f1; border-radius: 8px; padding: 20px; text-align: center; }
        .forecast-card .temp { font-weight: bold; color: #34495e; margin-top: 10px; font-size: 1.2em; }
        .forecast-card .day { font-size: 1.1em; color: #7f8c8d; }

        /* =========================================
           2. MARKETPLACE & PAYMENT STYLES
           ========================================= */
        
        .marketplace-card-buy { background-color: #e6f7ff; border: 1px solid #90d3ff; padding: 20px; }
        .marketplace-card-buy th { background-color: #cce9ff !important; }
        .marketplace-card-buy .data-table { margin-top: 15px; border: none; }
        .marketplace-card-buy .data-table td, .marketplace-card-buy .data-table th { padding: 12px 8px; border: none; border-bottom: 1px solid #ddd; }
        .marketplace-card-sell { background-color: #e6fff3; border: 1px solid #b3ffcc; }
        
        .marketplace-btn-buy { background-color: #3498db !important; margin-top: 20px !important; }
        .marketplace-btn-cart { background-color: #e67e22 !important; margin-top: 20px !important; margin-left: 10px !important; }
        .marketplace-btn-sell { background-color: #1abc9c !important; }
        .buy-action-btn { background-color: #4CAF50; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 1em; width: auto; margin: 0; transition: background-color 0.2s; }

        /* Rental Grid System */
        .rental-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-top: 25px; }
        .rental-card { background: white; border: 1px solid #eee; border-radius: 10px; box-shadow: 0 3px 8px rgba(0,0,0,0.08); transition: transform 0.2s; overflow: hidden; }
        .rental-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        
        .rental-header { background: #2c3e50; color: white; padding: 20px; text-align: center; }
        .rental-body { padding: 25px; text-align: center; }
        .rental-price { font-size: 1.8em; color: #27ae60; font-weight: bold; margin: 15px 0; }
        .rental-unit { font-size: 0.7em; color: #7f8c8d; font-weight: normal; }
        
        .check-btn { background-color: #f39c12 !important; margin-top: 15px !important; width: 100%; padding: 16px; }
        .rent-now-btn { background-color: #2980b9 !important; margin-top: 15px !important; display: none; width: 100%; padding: 16px; }

        /* Universal Modal Styling */
        .payment-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center;
            z-index: 1100;
        }
        .payment-modal {
            background: #fff; padding: 40px; border-radius: 12px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            max-width: 500px; width: 90%; text-align: left;
            max-height: 90vh; overflow-y: auto;
        }
        .payment-modal h3 { text-align: center; color: #3498db; margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 15px; font-size: 1.8em; }
        
        .payment-step { display: none; } 
        .payment-step.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* UPDATED: Realistic QR Scanner Animation */
        .qr-code-box {
            width: 280px; height: 280px; margin: 20px auto;
            position: relative;
            background-color: #000;
            border: 4px solid #2ecc71;
            border-radius: 20px; 
            overflow: hidden;
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.4);
            background-image: url('https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=UPI%3A%2F%2Fpay%3Fpa%3Dagrisense%40upi%26pn%3DAgriSense'); /* Real Generated QR */
            background-size: cover;
            background-position: center;
        }

        /* Camera Viewfinder Corners */
        .qr-code-box::before, .qr-code-box::after {
            content: ''; position: absolute; width: 40px; height: 40px; 
            border: 4px solid #fff; 
            z-index: 5;
        }
        .qr-code-box::before { top: 10px; left: 10px; border-right: none; border-bottom: none; }
        .qr-code-box::after { top: 10px; right: 10px; border-left: none; border-bottom: none; }
        
        .qr-scanner-line {
            width: 100%; height: 3px; 
            background: #e74c3c; 
            position: absolute; top: 0; left: 0;
            box-shadow: 0 0 15px #e74c3c, 0 0 30px #e74c3c; 
            animation: scanMove 1.5s infinite linear; 
            z-index: 10;
            opacity: 0.8;
        }
        
        @keyframes scanMove {
            0% { top: 5%; opacity: 0; } 
            10% { opacity: 1; } 
            90% { opacity: 1; } 
            100% { top: 95%; opacity: 0; }
        }
        
        .catalog-list { max-height: 350px; overflow-y: auto; }
        .catalog-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; font-size: 1.1em; }
        .cat-tag { font-size: 0.8em; background: #eee; padding: 4px 8px; border-radius: 4px; color: #555; margin-left: 8px; }
        .close-modal-btn { background-color: #e74c3c !important; margin-top: 20px !important; width: 100%; }
        .checkout-btn { background-color: #27ae60 !important; margin-top: 20px !important; width: 100%; }
        
        /* --- 3. REPORT CARD STYLES --- */
        .report-grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-top: 25px; }
        
        .report-card { 
            background: white; border-radius: 12px; padding: 30px; text-align: center; 
            box-shadow: 0 3px 8px rgba(0,0,0,0.08); transition: transform 0.2s; 
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .report-card:hover { transform: translateY(-5px); }
        
        .card-green { border: 2px solid #2ecc71; }
        .card-orange { border: 2px solid #f39c12; }
        .card-blue { border: 2px solid #2980b9; }
        
        .report-icon { font-size: 3em; display: block; margin-bottom: 12px; }

        .report-title { 
            font-weight: 800; color: #7f8c8d; text-transform: uppercase; font-size: 1.1rem; 
            letter-spacing: 1px; margin-bottom: 12px;
            display: flex; align-items: center; justify-content: center; gap: 8px; 
        }
        .report-desc { font-size: 1.1rem; color: #555; margin-bottom: 25px; min-height: 40px; line-height: 1.5; }
        
        .report-download-btn { 
            width: 100%; padding: 15px 24px; 
            border: none; border-radius: 5px; color: white; font-weight: 700; 
            cursor: pointer; font-size: 1.1em; transition: opacity 0.2s; 
        }
        .report-download-btn:hover { opacity: 0.9; }
        .btn-green { background-color: #2ecc71; }
        .btn-orange { background-color: #f39c12; }
        .btn-blue { background-color: #2980b9; }

        .custom-report-box { background-color: #fff9c4; border-radius: 10px; padding: 25px; margin-top: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.06); }
        .custom-report-header { font-weight: 800; color: #7f8c8d; margin-bottom: 15px; text-transform: uppercase; font-size: 1.2em; display: flex; align-items: center; gap: 10px; }
        .cr-flex { display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap; }
        .cr-group { flex: 1; min-width: 160px; }
        
        .cr-label { font-weight: 800; color: #2e7d32; font-size: 1.1em; margin-bottom: 6px; display: block; }
        .cr-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: white; box-sizing: border-box; font-size: 1.1em; }
        .cr-gen-btn { background-color: #f39c12; color: white; padding: 0 30px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; height: 48px; transition: background 0.2s; font-size: 1.1em; }
        
        /* --- LOGIN TOGGLE STYLES --- */
        .auth-toggle-text { text-align: center; margin-top: 15px; font-size: 0.95em; cursor: pointer; color: #3498db; text-decoration: underline; }
        .auth-form-hidden { display: none; }
        #feature-content { display: none; } /* Hidden by default */
        
        /* --- ACCESS BARRIER STYLES --- */
        .login-barrier {
            text-align: center; 
            padding: 60px 30px; 
            background-color: white; 
            border-radius: 12px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            max-width: 650px; 
            margin: 50px auto;
        }
        .barrier-icon { font-size: 3em; margin-bottom: 20px; display: block; color: #2ecc71; }
        .barrier-title { font-size: 2em; color: #e74c3c; margin-bottom: 12px; font-weight: bold; }
        .barrier-desc { color: #7f8c8d; margin-bottom: 30px; font-size: 1.1em; line-height: 1.5; }
        .barrier-btn { background-color: #3498db; padding: 15px 40px; font-size: 1.3em; border-radius: 8px; transition: transform 0.2s; width: 70%; display: inline-block; font-weight: bold; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3); }
        .barrier-btn:hover { transform: scale(1.02); background-color: #2980b9; }

        /* --- SMART IOT STYLES --- */
        .iot-device-card {
            background: white; border-radius: 12px; padding: 25px;
            border: 1px solid #e0e0e0; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            position: relative; overflow: hidden;
        }
        .device-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .signal-indicator { display: flex; align-items: flex-end; height: 15px; gap: 2px; }
        .signal-bar { width: 4px; background-color: #ccc; border-radius: 2px; }
        .signal-bar.active { background-color: #2ecc71; }

        /* Motor Animation */
        .motor-icon-box {
            width: 80px; height: 80px; background: #f0f4f7; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 15px auto; transition: all 0.3s; border: 4px solid #ccc;
        }
        .motor-icon-box.running { border-color: #2ecc71; background: #e8f5e9; }
        .motor-fan { font-size: 40px; color: #7f8c8d; transition: color 0.3s; }
        .motor-icon-box.running .motor-fan { 
            color: #2ecc71; 
            animation: spin 0.8s linear infinite; 
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Toggle Switch */
        .iot-switch-container { display: flex; justify-content: center; margin-top: 20px; }
        .iot-toggle {
            position: relative; width: 60px; height: 30px;
            background-color: #ccc; border-radius: 30px; cursor: pointer; transition: 0.3s;
        }
        .iot-toggle::after {
            content: ''; position: absolute; top: 2px; left: 2px;
            width: 26px; height: 26px; background-color: white; border-radius: 50%;
            transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .iot-toggle.active { background-color: #2ecc71; }
        .iot-toggle.active::after { transform: translateX(30px); }

        /* Logs */
        .iot-log-terminal {
            background-color: #1e1e1e; color: #00ff00; font-family: 'Courier New', monospace;
            padding: 15px; border-radius: 6px; font-size: 0.85em; height: 200px; overflow-y: auto;
            border: 1px solid #333;
        }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .log-timestamp { color: #888; margin-right: 10px; }

        /* Hidden/Visible States */
        .device-online-panel { display: none; }
        .no-device-panel { text-align: center; padding: 40px 0; }

        /* =========================================
           4. UPGRADED CHAT UI STYLES
           ========================================= */
        .chat-window { max-width: 800px; margin: 0 auto; background: #fff; border-radius: 12px; display: flex; flex-direction: column; height: 650px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid #e0e0e0; }
        
        .chat-header {
            background-color: #2c3e50; color: white; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .chat-messages { flex-grow: 1; padding: 25px; overflow-y: auto; background-color: #f4f6f8; scroll-behavior: smooth; }
        
        .message { margin-bottom: 20px; display: flex; align-items: flex-start; animation: fadeInUp 0.3s ease; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .bot-message { justify-content: flex-start; }
        .user-message { justify-content: flex-end; }
        
        .avatar {
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.2em; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .bot-avatar { background-color: #e0f2f1; margin-right: 12px; color: #00695c; }
        .user-avatar { background-color: #e3f2fd; margin-left: 12px; color: #1565c0; }

        .bot-bubble { 
            background-color: white; color: #333; padding: 15px 20px; 
            border-radius: 0 15px 15px 15px; border: 1px solid #eee;
            max-width: 80%; font-size: 1.05em; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .user-bubble { 
            background-color: #3498db; color: white; padding: 15px 20px; 
            border-radius: 15px 0 15px 15px; 
            max-width: 80%; font-size: 1.05em; line-height: 1.5; box-shadow: 0 2px 5px rgba(52, 152, 219, 0.4);
        }

        /* Rich Response Table */
        .chat-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        .chat-table th { background: #f8f9fa; text-align: left; padding: 8px; border-bottom: 2px solid #ddd; }
        .chat-table td { padding: 8px; border-bottom: 1px solid #eee; }
        
        /* Quick Actions */
        .quick-actions { 
            padding: 10px 15px; background: white; border-top: 1px solid #eee;
            display: flex; gap: 10px; overflow-x: auto; white-space: nowrap;
        }
        .chip { 
            background: #eef2f5; border: 1px solid #dce2e6; color: #555; padding: 8px 16px; 
            border-radius: 20px; font-size: 0.9em; cursor: pointer; transition: 0.2s; margin: 0; width: auto; font-weight: 500;
        }
        .chip:hover { background: #dbe2e8; color: #2c3e50; transform: translateY(-1px); }

        /* Input Area */
        .chat-input-area { 
            padding: 15px; background: white; border-top: 1px solid #eee; display: flex; align-items: center; gap: 10px; 
        }
        .chat-input-area input { 
            flex-grow: 1; padding: 12px 18px; border: 1px solid #ccc; border-radius: 25px; 
            font-size: 1em; outline: none; transition: 0.2s; margin: 0;
        }
        .chat-input-area input:focus { border-color: #3498db; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        
        .icon-btn {
            width: 45px; height: 45px; border-radius: 50%; border: none; background: #f0f2f5; color: #555;
            cursor: pointer; font-size: 1.2em; display: flex; align-items: center; justify-content: center; margin: 0; padding: 0;
        }
        .icon-btn:hover { background: #e1e4e8; }
        
        .send-btn { 
            width: 50px; height: 45px; border-radius: 25px; border: none; background: #1abc9c; color: white;
            cursor: pointer; font-size: 1.2em; margin: 0; padding: 0; display: flex; align-items: center; justify-content: center;
        }
        .send-btn:hover { background: #16a085; }

        /* Typing Indicator */
        .typing-indicator { display: inline-flex; gap: 4px; padding: 5px 0; }
        .typing-dot { width: 6px; height: 6px; background: #999; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* ADDED: Top Header Bar for Welcome Message */
        .top-header-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #e0e0e0;
        }
        .welcome-msg { font-size: 1.2em; color: #2c3e50; font-weight: 600; display: none; }

        /* UPDATED: Unified Header Icons (Same Size) */
        .header-icon-btn {
            font-size: 1.5em;
            cursor: pointer;
            margin-left: 20px; /* Spacing between icons */
            background: none;
            border: none;
            padding: 0;
            color: #555;
            transition: transform 0.2s;
            width: auto;
        }
        .header-icon-btn:hover { transform: scale(1.1); color: #2c3e50; }

        /* Dropdown Language Selector */
        .language-selector-container { position: relative; display: inline-block; }
        .lang-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 6px;
            z-index: 2000;
            min-width: 150px;
            overflow: hidden;
            text-align: left;
        }
        .lang-dropdown div { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.95em; }
        .lang-dropdown div:hover { background-color: #f0f4f7; }
        .lang-dropdown.show { display: block; }
        
        /* UPDATED: Equal Sized Buttons for Marketplace */
        .action-btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .action-btn-group button {
            margin: 0 !important; /* Reset default margins */
            flex: 1; /* Force equal width */
            height: 55px; /* Force equal height */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.1em;
        }
        
        .marketplace-btn-sell { background-color: #1abc9c !important; }
        .bank-btn { background-color: #2c3e50 !important; }
        .bank-btn:hover { background-color: #34495e !important; }

        /* --- ADDED: SHOW ALL BUTTON STYLE --- */
        .show-more-btn {
            background: none !important; 
            border: none; 
            color: #3498db;
            font-weight: bold; 
            cursor: pointer; 
            padding: 10px;
            width: 100%; 
            text-align: center; 
            display: block;
            margin-top: 5px; 
            text-decoration: underline;
            font-size: 1em;
            box-shadow: none !important;
        }
        .show-more-btn:hover { color: #2980b9; background-color: transparent !important; transform: none !important; }
    </style>
    <script>
        // --- 1. CLIENT-SIDE UTILITIES ---
        
        // Global store for Bank Details (Simulation)
        let userBankDetails = JSON.parse(localStorage.getItem('agri_bank')) || {
            accountName: "",
            accountNumber: "",
            ifsc: "",
            bankName: ""
        };
        
        // Global Transaction History Store (Persisted)
        // Adding more mock data to test the "Show All" feature
        let transactionHistory = JSON.parse(localStorage.getItem('agri_transactions')) || [
            { date: '2025-11-20', type: 'BUY', item: 'Wheat Seeds (50kg)', amount: 4500, status: 'Success' },
            { date: '2025-11-22', type: 'RENT', item: 'Tractor (5hrs)', amount: 4000, status: 'Success' },
            { date: '2025-11-23', type: 'SOLD', item: 'Cotton (2Q)', amount: 12000, status: 'Received' },
            { date: '2025-11-24', type: 'BUY', item: 'Urea Fertilizer', amount: 500, status: 'Success' },
            { date: '2025-11-25', type: 'RENT', item: 'Harvester', amount: 8000, status: 'Pending' },
            { date: '2025-11-26', type: 'BUY', item: 'Pesticide', amount: 1200, status: 'Success' }
        ];
        
        // Global Current Listings Store (Persisted)
        let currentListings = JSON.parse(localStorage.getItem('agri_listings')) || [
            { id: 1, crop: 'Rice (Basmati)', quantity: 250, price: 2500, seller: 'Farmer 101', date: '1 day ago' },
            { id: 2, crop: 'Maize', quantity: 150, price: 1750, seller: 'AgriCorp', date: '3 hours ago' },
            { id: 3, crop: 'Wheat (Lokwan)', quantity: 50, price: 2400, seller: 'Local Farm', date: '5 minutes ago' },
            { id: 4, crop: 'Cotton', quantity: 100, price: 6200, seller: 'CottonKing', date: 'Just now' },
            { id: 5, crop: 'Sugarcane', quantity: 500, price: 310, seller: 'SweetHarvest', date: '2 days ago' },
            { id: 6, crop: 'Soybean', quantity: 80, price: 4100, seller: 'Organic Farms', date: '4 hours ago' },
            { id: 7, crop: 'Potato', quantity: 200, price: 1200, seller: 'Root Traders', date: '1 hour ago' }
        ];

        // --- NEW: STATE VARIABLES FOR TOGGLING VIEWS ---
        let isHistoryExpanded = false;
        let isReportExpanded = false;

        window.onload = function() {
            var chatDiv = document.getElementById("chat-messages");
            if (chatDiv) { chatDiv.scrollTop = chatDiv.scrollHeight; }
            
            // Initialize Login State on Load
            checkLoginState();
            
            // Populate 7-crop tables (Yield/Schedules) if elements exist
            renderFullCropTables();
            
            // Start Background Simulation for Alerts & Buyers
            startEnvironmentalSimulation();
            startMarketplaceSimulation();
            
            // Render Transaction History if on Marketplace or Reports page
            if(document.getElementById('marketplace-history-body')) renderTransactionHistory();
            if(document.getElementById('live-report-preview')) renderLiveReport();
            
            // Initialize Analytics if on Analytics page
            if(document.getElementById('yieldChart')) initAnalyticsCharts();
        };
        
        // Helper: Save Data to LocalStorage
        function saveData() {
            localStorage.setItem('agri_transactions', JSON.stringify(transactionHistory));
            localStorage.setItem('agri_listings', JSON.stringify(currentListings));
            localStorage.setItem('agri_bank', JSON.stringify(userBankDetails));
        }

        // Click outside to close language menu
        window.onclick = function(event) {
            if (!event.target.matches('.header-icon-btn')) {
                var dropdowns = document.getElementsByClassName("lang-dropdown");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            var chatDiv = document.getElementById("chat-messages");
            if (chatDiv) { chatDiv.scrollTop = chatDiv.scrollHeight; }
        });

        // --- 2. MARKETPLACE DATA & LOGIC ---

        // Rental Equipment Data (For Dynamic Generation)
        const rentalEquipment = [
            { id: 101, name: 'Mahindra 575 DI', type: 'Tractor', rate: 800, unit: 'Hour', available: true },
            { id: 102, name: 'John Deere S780', type: 'Harvester', rate: 4500, unit: 'Acre', available: false }, 
            { id: 103, name: 'Drone Sprayer (10L)', type: 'IoT Device', rate: 500, unit: 'Hectare', available: true },
            { id: 104, name: 'Rotavator 6ft', type: 'Attachment', rate: 300, unit: 'Hour', available: true }
        ];

        // Market Catalog Data (For Browse Modal)
        const marketCatalog = [
            { name: 'Pusa 1121 Basmati Seeds', category: 'Seeds', price: 1500, unit: 'Kg' },
            { name: 'Urea (46% Nitrogen)', category: 'Fertilizer', price: 270, unit: 'Bag' },
            { name: 'DAP (Di-ammonium Phosphate)', category: 'Fertilizer', price: 1250, unit: 'Bag' },
            { name: 'Roundup Herbicide', category: 'Pesticide', price: 450, unit: 'Litre' },
            { name: 'Netafim Drip Tape', category: 'Irrigation', price: 3500, unit: 'Roll' },
            { name: 'Potash Granules', category: 'Fertilizer', price: 900, unit: 'Bag' }
        ];

        // *** SHOPPING CART STORE ***
        let cart = [];

        // --- 3. WEATHER LOGIC ---
        async function getAccurateLiveWeather() {
            const MOCK_LIVE_WEATHER = {
                temp: 34, condition: 'High Solar Load, Dry', humidity: 60, wind: 12, icon: '☀️', color: 'bg-yellow-600', location: 'Raichur District, Karnataka (Live)'
            };
            await new Promise(resolve => setTimeout(resolve, 1500));
            return MOCK_LIVE_WEATHER;
        }

        // --- 4. RENDER FUNCTIONS ---

        function renderActiveListings() {
            const listingsBody = document.getElementById('active-crop-listings-body');
            if (!listingsBody) return;

            if (currentListings.length === 0) {
                listingsBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #7f8c8d;">No crops are currently listed for sale.</td></tr>';
                return;
            }

            let html = '';
            currentListings.forEach(listing => {
                const totalPrice = listing.quantity * listing.price;
                html += `
                    <tr>
                        <td style="font-weight: bold; color: #00796b;">${listing.crop}</td>
                        <td>${listing.quantity} Q</td>
                        <td>₹${listing.price} / Q</td>
                        <td style="font-size: 0.85em;">${listing.seller}</td>
                        <td>
                            <button onclick="initiateRealPayment('BUY', ${listing.id})" class="buy-action-btn">Pay & Buy</button>
                        </td>
                    </tr>
                `;
            });
            listingsBody.innerHTML = html;
        }
        
        // --- UPDATED: Render Transaction History Table with Toggle ---
        function renderTransactionHistory() {
            const historyBody = document.getElementById('marketplace-history-body');
            const toggleBtn = document.getElementById('show-all-tx-btn');
            
            if (!historyBody) return;
            
            if (transactionHistory.length === 0) {
                historyBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999;">No transactions yet.</td></tr>';
                if(toggleBtn) toggleBtn.style.display = 'none';
                return;
            }
            
            // Determine how many items to show
            const limit = 5;
            let displayData = transactionHistory;
            
            if (!isHistoryExpanded && transactionHistory.length > limit) {
                displayData = transactionHistory.slice(0, limit);
                if(toggleBtn) {
                    toggleBtn.style.display = 'block';
                    toggleBtn.innerText = "Show All Transactions (" + transactionHistory.length + ")";
                }
            } else {
                if(toggleBtn) {
                    if (transactionHistory.length <= limit) {
                        toggleBtn.style.display = 'none';
                    } else {
                        toggleBtn.style.display = 'block';
                        toggleBtn.innerText = "Show Less";
                    }
                }
            }
            
            let html = '';
            displayData.forEach(tx => {
                let statusColor = tx.status === 'Success' || tx.status === 'Received' ? 'green' : 'red';
                html += `
                    <tr>
                        <td>${tx.date}</td>
                        <td style="font-weight:bold;">${tx.type}</td>
                        <td>${tx.item}</td>
                        <td>₹${tx.amount}</td>
                        <td style="color:${statusColor}; font-weight:bold;">${tx.status}</td>
                    </tr>
                `;
            });
            historyBody.innerHTML = html;
        }

        // Toggle Function for Marketplace
        function toggleHistoryView() {
            isHistoryExpanded = !isHistoryExpanded;
            renderTransactionHistory();
        }
        
        // --- UPDATED: Render Live Report Preview with Toggle ---
        function renderLiveReport() {
             const container = document.getElementById('live-report-preview');
             const toggleBtn = document.getElementById('toggle-report-btn');
             if(!container) return;
             
             const limit = 5;
             let displayData = transactionHistory;
             
             if (!isReportExpanded && transactionHistory.length > limit) {
                 displayData = transactionHistory.slice(0, limit);
                 if(toggleBtn) {
                     toggleBtn.style.display = 'block';
                     toggleBtn.innerText = "Show Full Report Log";
                 }
             } else {
                 if(toggleBtn) {
                     if (transactionHistory.length <= limit) {
                         toggleBtn.style.display = 'none';
                     } else {
                         toggleBtn.style.display = 'block';
                         toggleBtn.innerText = "Show Less";
                     }
                 }
             }

             let html = '<table class="data-table" style="font-size:0.9em;"><thead><tr><th>Date</th><th>Activity</th><th>Amount</th></tr></thead><tbody>';
             displayData.forEach(tx => {
                 html += `<tr><td>${tx.date}</td><td>${tx.type}: ${tx.item}</td><td>₹${tx.amount}</td></tr>`;
             });
             html += '</tbody></table>';
             container.innerHTML = html;
        }

        // Toggle Function for Reports
        function toggleReportView() {
            isReportExpanded = !isReportExpanded;
            renderLiveReport();
        }
        
        // NEW: Initialize Analytics Charts
        function initAnalyticsCharts() {
            // Calculate Live Totals
            let totalRevenue = 0;
            let totalExpenses = 0;
            
            transactionHistory.forEach(tx => {
                if(tx.type === 'SOLD') totalRevenue += tx.amount;
                if(tx.type === 'BUY' || tx.type === 'RENT') totalExpenses += tx.amount;
            });

            // 1. Financial Chart (Dynamic Data)
            new Chart(document.getElementById('yieldChart'), {
                type: 'bar',
                data: {
                    labels: ['Historical Avg', 'Current Session'],
                    datasets: [
                        { label: 'Expenses (₹)', data: [15000, totalExpenses], backgroundColor: '#e74c3c' },
                        { label: 'Revenue (₹)', data: [25000, totalRevenue], backgroundColor: '#2ecc71' }
                    ]
                }
            });
            
            // 2. Resource Chart
            new Chart(document.getElementById('resourceChart'), {
                type: 'line',
                data: {
                    labels: ['W1', 'W2', 'W3', 'W4'],
                    datasets: [{ label: 'Water Usage (Liters)', data: [500, 450, 600, 550], borderColor: '#3498db', fill: false }]
                }
            });
            
            // Update AI Insight Text
            const aiText = document.getElementById('analytics-ai-text');
            if(aiText) {
                if(totalRevenue > totalExpenses) aiText.innerText = `Great job! You are currently profitable by ₹${totalRevenue - totalExpenses}. Keep monitoring fertilizer costs.`;
                else aiText.innerText = `Alert: Expenses (₹${totalExpenses}) are currently higher than Revenue. Review your spending on inputs.`;
            }
        }

        function renderRentals() {
            const container = document.getElementById('rental-grid-container');
            if(!container) return;
            
            let html = '';
            rentalEquipment.forEach(item => {
                html += `
                    <div class="rental-card" id="card-${item.id}">
                        <div class="rental-header">
                            <h3 style="margin:0;">${item.name}</h3>
                            <div style="font-size:0.8em; opacity:0.8">${item.type}</div>
                        </div>
                        <div class="rental-body">
                            <div class="rental-price">₹${item.rate} <span class="rental-unit">/ ${item.unit}</span></div>
                            
                            <div id="status-${item.id}" style="margin: 10px 0; color: #7f8c8d; font-size: 0.9em;">
                                Status: <span style="font-weight:bold;">Unknown</span>
                            </div>

                            <button onclick="checkAvailability(${item.id})" class="check-btn" id="btn-check-${item.id}">Check Availability</button>
                            <button onclick="initiateRealPayment('RENTAL', ${item.id})" class="rent-now-btn" id="btn-rent-${item.id}">Rent Now</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function checkAvailability(id) {
            const btn = document.getElementById(`btn-check-${id}`);
            const statusDiv = document.getElementById(`status-${id}`);
            const rentBtn = document.getElementById(`btn-rent-${id}`);
            const item = rentalEquipment.find(i => i.id === id);

            // UI Loading State
            btn.textContent = "Checking...";
            btn.disabled = true;
            btn.style.backgroundColor = "#95a5a6";

            // Simulate Network Delay (1.5s)
            setTimeout(() => {
                btn.style.display = 'none'; // Hide check button
                
                if (item.available) {
                    statusDiv.innerHTML = 'Status: <span style="color: #27ae60; font-weight:bold;">✅ Available</span>';
                    rentBtn.style.display = 'block'; // Show Rent button
                } else {
                    statusDiv.innerHTML = 'Status: <span style="color: #c0392b; font-weight:bold;">❌ Currently Busy</span>';
                    btn.style.display = 'block';
                    btn.textContent = "Notify When Free"; // Change text to Notify
                    btn.disabled = false;
                    btn.style.backgroundColor = "#e67e22";
                    btn.onclick = function() { alert("We will SMS you when this machine is free."); };
                }
            }, 1500);
        }

        function openCatalogModal() {
            const listDiv = document.getElementById('catalog-list-container');
            let html = '';
            marketCatalog.forEach((item, index) => {
                html += `
                    <div class="catalog-item">
                        <div>
                            <strong>${item.name}</strong> <span class="cat-tag">${item.category}</span>
                        </div>
                        <div style="text-align:right;">
                            <div style="color:#27ae60; font-weight:bold;">₹${item.price} / ${item.unit}</div>
                            <button onclick="addToCart(${index})" class="buy-action-btn" style="background-color:#f39c12; margin-top:5px;">Add to Cart</button>
                        </div>
                    </div>
                `;
            });
            listDiv.innerHTML = html;
            document.getElementById('catalog-modal').style.display = 'flex';
        }

        // --- NEW: CART FUNCTIONS ---
        
        function addToCart(index) {
            const item = marketCatalog[index];
            cart.push(item);
            
            const cartBtn = document.getElementById('btn-view-cart');
            if(cartBtn) cartBtn.innerText = `View Cart (${cart.length})`;
            
            alert(`${item.name} added to cart!`);
        }

        function openCartModal() {
            const listDiv = document.getElementById('cart-list-container');
            const totalSpan = document.getElementById('cart-total-price');
            const checkoutBtn = document.getElementById('btn-checkout-cart');

            if(cart.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center; color:#777;">Your cart is empty.</p>';
                totalSpan.innerText = '0';
                checkoutBtn.style.display = 'none';
            } else {
                let html = '';
                let total = 0;
                cart.forEach((item, idx) => {
                    total += item.price;
                    html += `
                        <div class="catalog-item">
                            <div><strong>${item.name}</strong></div>
                            <div style="text-align:right;">
                                <span style="color:#27ae60;">₹${item.price}</span>
                                <button onclick="removeFromCart(${idx})" style="background:#e74c3c; color:white; border:none; border-radius:4px; padding:2px 6px; margin-left:5px; cursor:pointer;">X</button>
                            </div>
                        </div>`;
                });
                listDiv.innerHTML = html;
                totalSpan.innerText = total;
                checkoutBtn.style.display = 'block';
            }
            document.getElementById('cart-modal').style.display = 'flex';
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            const cartBtn = document.getElementById('btn-view-cart');
            if(cartBtn) cartBtn.innerText = `View Cart (${cart.length})`;
            openCartModal(); // Re-render
        }
        
        function checkoutCart() {
            let total = 0;
            cart.forEach(i => total += i.price);
            document.getElementById('cart-modal').style.display = 'none';
            initiateRealPayment('CART', null, total);
        }


        // --- 5. REAL PAYMENT FLOW (QR -> AMOUNT -> PIN) ---
        
        let transactionData = {};

        function initiateRealPayment(type, id, overrideAmount=0) {
            transactionData = { type: type, id: id };
            
            if (type === 'BUY') {
                const item = currentListings.find(i => i.id === id);
                transactionData.amount = item.price * item.quantity;
                transactionData.desc = `Buying ${item.crop} (${item.quantity} Q)`;
            } else if (type === 'RENTAL') {
                const item = rentalEquipment.find(i => i.id === id);
                let duration = prompt(`Enter number of ${item.unit}s to rent:`, "5");
                if(!duration || isNaN(duration)) return;
                
                transactionData.amount = item.rate * parseInt(duration);
                transactionData.desc = `Renting ${item.name} for ${duration} ${item.unit}s`;
            } else if (type === 'CART') {
                transactionData.amount = overrideAmount;
                transactionData.desc = `Cart Checkout (${cart.length} items)`;
            }

            document.querySelectorAll('.payment-step').forEach(el => el.classList.remove('active'));
            document.getElementById('step-1').classList.add('active');
            
            document.getElementById('pay-desc-text').textContent = transactionData.desc;
            document.getElementById('pay-amount-preview').textContent = transactionData.amount;
            
            document.getElementById('payment-modal-overlay').style.display = 'flex';
        }

        function showQrScan() {
            document.getElementById('step-1').classList.remove('active');
            document.getElementById('step-2').classList.add('active'); 
            
            setTimeout(() => {
                document.getElementById('step-2').classList.remove('active');
                document.getElementById('step-3').classList.add('active'); 
                
                document.getElementById('final-amount-input').value = "₹ " + transactionData.amount;
            }, 3000);
        }

        function verifyPinAndComplete() {
            const pin = document.getElementById('upi-pin-input').value;
            if(pin.length !== 4) {
                alert("Please enter a valid 4-digit PIN.");
                return;
            }

            const btn = document.getElementById('pay-btn-final');
            const originalText = btn.textContent;
            btn.textContent = "Processing...";
            btn.disabled = true;
            
            setTimeout(() => {
                document.getElementById('payment-modal-overlay').style.display = 'none';
                
                alert(`✅ TRANSACTION SUCCESSFUL!\n\nPaid ₹${transactionData.amount} for ${transactionData.desc}.\nTransaction ID: TXN${Date.now()}`);
                
                // --- NEW: Add to Transaction History & SAVE ---
                const newTxn = {
                    date: new Date().toLocaleDateString(),
                    type: transactionData.type,
                    item: transactionData.desc,
                    amount: transactionData.amount,
                    status: 'Success'
                };
                transactionHistory.unshift(newTxn);
                saveData(); // PERSIST
                
                // Update UI based on current view
                if(document.getElementById('marketplace-history-body')) renderTransactionHistory();
                if(document.getElementById('live-report-preview')) renderLiveReport();
                
                if(transactionData.type === 'BUY') {
                    const item = currentListings.find(l => l.id === transactionData.id);
                    
                    // Notification for Buyer
                    sendPushNotification("✅ Payment Sent", `Paid ₹${transactionData.amount} to ${item.seller}`);
                    
                    // Remove listing and Save
                    currentListings = currentListings.filter(l => l.id !== transactionData.id);
                    saveData(); // PERSIST
                    renderActiveListings();
                } 
                else if (transactionData.type === 'CART') {
                    sendPushNotification("✅ Payment Sent", `Cart Checkout Complete: ₹${transactionData.amount}`);
                    cart = []; 
                    document.getElementById('btn-view-cart').innerText = 'View Cart (0)';
                }
                
                btn.textContent = originalText;
                btn.disabled = false;
                document.getElementById('upi-pin-input').value = "";
            }, 1500);
        }

        // --- 6. POST LISTING LOGIC ---
        window.postCropListing = function(event) {
            event.preventDefault();
            const form = event.target;
            const crop = form.sell_crop.value;
            const quantity = parseFloat(form.quantity.value);
            const price = parseFloat(form.price.value);

            if (isNaN(quantity) || isNaN(price) || quantity <= 0 || price <= 0) {
                alert("Please enter valid positive numbers.");
                return;
            }

            const newListing = {
                id: Date.now(), crop: crop, quantity: quantity, price: price,
                seller: 'Current User', date: 'Just now'
            };

            currentListings.unshift(newListing);
            saveData(); // PERSIST
            renderActiveListings();
            form.reset();
            alert(`Listing successful! ${crop} has been posted.`);
            
            // UPDATED: Notification for listing
            sendPushNotification("📢 Listing Live", `Your ${crop} (${quantity}Q) is now live on the marketplace.`);
        };
        
        // --- SIMULATED BUYER BOT (MONEY RECEIVED) ---
        function startMarketplaceSimulation() {
            setInterval(() => {
                // Try to find a listing by 'Current User'
                const userListingIndex = currentListings.findIndex(l => l.seller === 'Current User');
                
                if (userListingIndex !== -1) {
                    const item = currentListings[userListingIndex];
                    const totalAmt = item.price * item.quantity;
                    
                    // Remove listing (simulating sold)
                    currentListings.splice(userListingIndex, 1);
                    
                    // Add to transaction history
                    transactionHistory.unshift({
                        date: new Date().toLocaleDateString(),
                        type: 'SOLD',
                        item: `Sold: ${item.crop}`,
                        amount: totalAmt,
                        status: 'Received'
                    });
                    
                    saveData(); // PERSIST
                    
                    // Refresh UI if on marketplace
                    renderActiveListings();
                    if(document.getElementById('marketplace-history-body')) renderTransactionHistory();
                    
                    // SEND REAL NOTIFICATION
                    const acct = userBankDetails.accountNumber ? userBankDetails.accountNumber.slice(-4) : 'XXXX';
                    const bank = userBankDetails.bankName || 'Bank';
                    sendPushNotification("💰 Money Received", `₹${totalAmt} credited to ${bank} A/C ending ${acct} for ${item.crop}.`);
                }
            }, 45000); // Run every 45 seconds
        }

        // --- BANK DETAILS LOGIC ---
        function openBankModal() {
            document.getElementById('bank-details-modal').style.display = 'flex';
        }
        
        function saveBankDetails() {
            const accName = document.getElementById('bank-name').value;
            const accNum = document.getElementById('bank-num').value;
            const ifsc = document.getElementById('bank-ifsc').value;
            
            if(accName && accNum && ifsc) {
                userBankDetails = {
                    accountName: accName,
                    accountNumber: accNum,
                    ifsc: ifsc,
                    bankName: "HDFC/SBI (Simulated)"
                };
                saveData(); // PERSIST
                alert("✅ Bank Details Saved Successfully!");
                document.getElementById('bank-details-modal').style.display = 'none';
            } else {
                alert("Please fill all fields.");
            }
        }

        // --- 7. LOGIN SYSTEM SIMULATION (STRICT BARRIER UPDATE) ---
        
        let isLoggedIn = false;
        let currentUser = "";
        let lastLoginDate = "";

        function checkLoginState() {
            const savedUser = localStorage.getItem('agri_user');
            const savedDate = localStorage.getItem('agri_last_login');
            
            const barrier = document.getElementById('login-barrier');
            const features = document.getElementById('feature-content');
            const headerMsg = document.getElementById('header-welcome-msg');

            if (savedUser) {
                isLoggedIn = true;
                currentUser = savedUser;
                lastLoginDate = savedDate || "First Login";
                
                if(barrier) barrier.style.display = 'none';
                if(features) features.style.display = 'block';
                
                if(headerMsg) {
                    headerMsg.style.display = 'block';
                    headerMsg.innerHTML = `👋 Welcome back, <span style="color:#27ae60;">${savedUser}</span>`;
                }
                
                updateSidebarUI();
            } else {
                isLoggedIn = false;
                
                if(barrier) barrier.style.display = 'block';
                if(features) features.style.display = 'none';
                if(headerMsg) headerMsg.style.display = 'none';
                
                updateSidebarUI();
            }
        }

        function handleAuthClick() {
            if (isLoggedIn) {
                logout();
            } else {
                // Reset to Password view
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('register-form').style.display = 'none';
                document.getElementById('login-modal').style.display = 'flex';
            }
        }

        function toggleAuthMode(mode) {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'none';
            
            if (mode === 'register') {
                document.getElementById('register-form').style.display = 'block';
            } else if (mode === 'login') {
                document.getElementById('login-form').style.display = 'block';
            }
        }
        
        function performRegister() {
            const user = document.getElementById('reg-username').value;
            const pass = document.getElementById('reg-password').value;
            const email = document.getElementById('reg-email').value;

            if(user && pass && email) {
                alert("✅ Account Created Successfully! Please Log In.");
                toggleAuthMode('login');
                document.getElementById('login-username').value = user;
            } else {
                alert("Please fill all registration fields.");
            }
        }

        function performLogin(manualUser=null, manualPass=null) {
            const user = manualUser || document.getElementById('login-username').value;
            const pass = manualPass || document.getElementById('login-password').value;

            if (user && pass) {
                isLoggedIn = true;
                currentUser = user;
                const now = new Date();
                lastLoginDate = now.toLocaleString(); 
                
                localStorage.setItem('agri_user', user);
                localStorage.setItem('agri_last_login', lastLoginDate);
                
                checkLoginState();
                
                document.getElementById('login-modal').style.display = 'none';
                document.getElementById('login-username').value = '';
                document.getElementById('login-password').value = '';
            } else {
                alert("Please enter both username and password.");
            }
        }

        function logout() {
            isLoggedIn = false;
            currentUser = "";
            localStorage.removeItem('agri_user');
            checkLoginState();
            alert("Logged out successfully.");
        }

        function updateSidebarUI() {
            const btn = document.getElementById('auth-btn');
            const infoPanel = document.getElementById('user-info-panel');
            const displayUser = document.getElementById('display-username');
            const displayDate = document.getElementById('display-last-login');

            if (isLoggedIn) {
                btn.innerHTML = "🔓 Logout";
                btn.style.backgroundColor = "#c0392b"; 
                displayUser.textContent = currentUser;
                displayDate.textContent = lastLoginDate;
                infoPanel.style.display = 'block';
            } else {
                btn.innerHTML = "🔑 Login / Sign Up";
                btn.style.backgroundColor = "#e67e22";
                infoPanel.style.display = 'none';
            }
        }

        // --- 8. REPORT GENERATION FUNCTIONS ---
        function generateReport(type) {
            const printWindow = window.open('', '_blank');
            let title = "";
            let content = "";
            
            // Calculate LIVE Totals
            let totalRevenue = 0;
            let totalExpenses = 0;
            transactionHistory.forEach(tx => {
                if(tx.type === 'SOLD') totalRevenue += tx.amount;
                if(tx.type === 'BUY' || tx.type === 'RENT') totalExpenses += tx.amount;
            });
            let netProfit = totalRevenue - totalExpenses;
            let roi = totalExpenses > 0 ? ((netProfit / totalExpenses) * 100).toFixed(1) : 0;

            if (type === 'soil') {
                title = "SOIL HEALTH REPORT";
                content = `
                    <div class="report-header"><h2>AgriSense AI Labs</h2><p>Date: ${new Date().toLocaleDateString()}</p></div><hr><h3>Analysis Results</h3><ul><li><strong>Nitrogen (N):</strong> 90 kg/ha (Normal)</li><li><strong>Phosphorus (P):</strong> 42 kg/ha (Low)</li><li><strong>Potassium (K):</strong> 43 kg/ha (High)</li><li><strong>pH Level:</strong> 6.5 (Neutral)</li></ul><div class="recommendation"><h4>AI Recommendation:</h4><p>Soil conditions are optimal for Rice and Wheat cultivation. Consider reducing Potash application by 10% to balance K levels.</p></div>
                `;
            } else if (type === 'yield') {
                title = "YIELD PREDICTION ANALYSIS";
                content = `
                    <div class="report-header"><h2>AgriSense AI Labs</h2><p>Date: ${new Date().toLocaleDateString()}</p></div>
                    <hr>
                    <h3>Forecast Data (All Crops)</h3>
                    <table border="1" cellpadding="10" cellspacing="0" width="100%" style="border-collapse:collapse;">
                        <tr style="background-color:#f2f2f2;"><th>Crop</th><th>Predicted Yield</th><th>Confidence</th></tr>
                        <tr><td>Wheat</td><td>45 Q/ha</td><td>92%</td></tr>
                        <tr><td>Rice</td><td>55 Q/ha</td><td>89%</td></tr>
                        <tr><td>Maize</td><td>60 Q/ha</td><td>90%</td></tr>
                        <tr><td>Cotton</td><td>25 Q/ha</td><td>85%</td></tr>
                        <tr><td>Sugarcane</td><td>80 Ton/ha</td><td>94%</td></tr>
                        <tr><td>Soybean</td><td>20 Q/ha</td><td>88%</td></tr>
                        <tr><td>Potato</td><td>25 Ton/ha</td><td>91%</td></tr>
                    </table>
                    <div style="margin-top:20px; padding:15px; background-color:#e8f5e9; border-radius:5px;">
                        <strong>🤖 AI Insight:</strong> Sugarcane and Wheat show the highest reliability this season based on soil moisture trends.
                    </div>
                    <p><em>*Prediction based on ARIMA/LSTM models.</em></p>
                `;
            } else if (type === 'profit') {
                title = "FARM COST & PROFIT ANALYSIS";
                content = `
                    <div class="report-header"><h2 style="color: #2c3e50;">AgriSense AI Labs</h2><p>Date: ${new Date().toLocaleDateString()}</p></div>
                    <hr>
                    <h3 style="color: #e74c3c;">Section 1: Real-Time Costs (Expenses)</h3>
                    <p>Calculated from your live purchase history.</p>
                    <table border="1" cellpadding="8" cellspacing="0" width="100%" style="border-collapse: collapse; margin-bottom: 20px;">
                        <tr style="background-color: #f2f2f2;"><th>Category</th><th>Amount (₹)</th></tr>
                        <tr><td>Inputs & Fertilizers (BUY)</td><td>${totalExpenses}</td></tr>
                        <tr style="font-weight: bold; background-color: #ffebee;"><td>Total Expenses</td><td>${totalExpenses}</td></tr>
                    </table>

                    <h3 style="color: #27ae60;">Section 2: Real-Time Revenue</h3>
                    <p>Calculated from your live sales history.</p>
                    <table border="1" cellpadding="8" cellspacing="0" width="100%" style="border-collapse: collapse; margin-bottom: 20px;">
                        <tr style="background-color: #f2f2f2;"><th>Source</th><th>Amount (₹)</th></tr>
                        <tr><td>Crop Sales (SOLD)</td><td>${totalRevenue}</td></tr>
                        <tr style="font-weight: bold; background-color: #e8f5e9;"><td>Total Revenue</td><td>${totalRevenue}</td></tr>
                    </table>

                    <h3 style="color: #2980b9;">Section 3: Financial Health</h3>
                    <div style="padding: 15px; background-color: #e3f2fd; border-left: 5px solid #2980b9; margin-bottom: 20px;">
                        <p><strong>Net Profit:</strong> ₹${netProfit}</p>
                        <p><strong>ROI:</strong> ${roi}%</p>
                    </div>

                    <h3 style="color: #8e44ad;">Section 4: AI Insights 🤖</h3>
                    <ul style="line-height: 1.6;">
                        <li>Your current net profit is ₹${netProfit}.</li>
                        <li>${netProfit > 0 ? "You are in profit! Consider reinvesting in better seeds." : "You are currently running a loss. Review your expense strategy."}</li>
                    </ul>
                `;
            }

            printWindow.document.write(`<html><head><title>${title}</title><style>body { font-family: sans-serif; padding: 40px; } .report-header { text-align: center; margin-bottom: 30px; } h2 { color: #2c3e50; margin: 0; } h3 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 20px; } .recommendation { background: #e8f5e9; padding: 15px; border-radius: 5px; margin-top: 20px; }</style></head><body><h1 style="text-align:center; color:#34495e;">${title}</h1>${content}<div style="text-align:center; margin-top:50px; color:#999; font-size:0.8em;">Generated by AgriSense AI</div></body></html>`);
            printWindow.document.close(); printWindow.focus(); setTimeout(() => { printWindow.print(); }, 500);
        }

        function generateCustomReport() {
            const start = document.getElementById('cr-start').value;
            const end = document.getElementById('cr-end').value;
            const type = document.getElementById('cr-type').value;

            let reportRows = "";
            transactionHistory.forEach(tx => {
                reportRows += `<tr><td style="padding:8px; border:1px solid #ddd">${tx.date}</td><td style="padding:8px; border:1px solid #ddd">${tx.type}</td><td style="padding:8px; border:1px solid #ddd">${tx.item}</td><td style="padding:8px; border:1px solid #ddd">₹${tx.amount}</td><td style="padding:8px; border:1px solid #ddd">${tx.status}</td></tr>`;
            });

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html><head><title>Custom Report</title><style>body { font-family: 'Segoe UI', sans-serif; padding: 50px; background-color: #fff; } h1 { color: #2c3e50; text-align: center; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1px; } table {width: 100%; border-collapse: collapse; margin-top: 20px;} th {background: #eee; padding: 10px; border: 1px solid #ccc;} </style></head><body><h1>CUSTOM ${type.toUpperCase()} REPORT</h1><p style="text-align:center">Period: ${start || 'All Time'} to ${end || 'Present'}</p><table><thead><tr><th>Date</th><th>Type</th><th>Item</th><th>Amount</th><th>Status</th></tr></thead><tbody>${reportRows}</tbody></table></body></html>
            `);
            printWindow.document.close(); printWindow.focus(); setTimeout(() => { printWindow.print(); }, 500);
        }

        // --- 9. SMART IOT LOGIC ---
        let isMotorOn = false;
        let isDevicePaired = false; // Simulates if user has scanned QR
        
        // --- ADDED: Timer Variables (Auto Mode variables removed) ---
        let timerInterval = null;

        function openPairingModal() {
            document.getElementById('iot-pairing-modal').style.display = 'flex';
        }

        function simulatePairingProcess() {
            const scanLine = document.getElementById('iot-scan-line');
            const statusText = document.getElementById('iot-scan-status');
            
            // 1. Start Scanning
            statusText.innerText = "Searching for Smart Motor Beacon...";
            statusText.style.color = "#e67e22";
            
            setTimeout(() => {
                // 2. Found Device
                statusText.innerHTML = "Device Found: <strong>Crompton-IoT-X500</strong><br>Verifying Firmware...";
                statusText.style.color = "#3498db";
                
                setTimeout(() => {
                    // 3. Success
                    statusText.innerHTML = "✅ Pairing Successful! Linking to Dashboard...";
                    statusText.style.color = "#2ecc71";
                    
                    setTimeout(() => {
                        // 4. Close and Update UI
                        isDevicePaired = true;
                        document.getElementById('iot-pairing-modal').style.display = 'none';
                        renderIoTState();
                        addIoTLog("SYSTEM", "New Device Paired: Crompton-IoT-X500 (MAC: A1:B2:C3)");
                    }, 1500);
                }, 2000);
            }, 2000);
        }

        function renderIoTState() {
            if(isDevicePaired) {
                document.getElementById('no-device-ui').style.display = 'none';
                document.getElementById('device-online-ui').style.display = 'block';
                updateSignalStrength();
            } else {
                document.getElementById('no-device-ui').style.display = 'block';
                document.getElementById('device-online-ui').style.display = 'none';
            }
        }

        function toggleSmartMotor() {
            const btn = document.getElementById('motor-toggle-btn');
            const iconBox = document.getElementById('motor-icon-container');
            const statusTxt = document.getElementById('motor-status-text');
            
            // Simulate Network Latency (Realistic IoT delay)
            statusTxt.innerText = "Sending Command...";
            statusTxt.style.color = "#e67e22";
            
            setTimeout(() => {
                isMotorOn = !isMotorOn;
                
                if(isMotorOn) {
                    btn.classList.add('active');
                    iconBox.classList.add('running');
                    statusTxt.innerHTML = "Status: <span style='color:#2ecc71; font-weight:bold;'>RUNNING (2400 RPM)</span>";
                    addIoTLog("MQTT_PUB", "Topic: agri/pump/01/set -> Payload: {state: ON, mode: MANUAL}");
                    addIoTLog("MQTT_SUB", "Ack: Motor Started Successfully.");
                    
                    // Send Browser Notification
                    sendPushNotification("Smart Motor Active", "Pump #1 has been started remotely.");
                } else {
                    btn.classList.remove('active');
                    iconBox.classList.remove('running');
                    statusTxt.innerHTML = "Status: <span style='color:#7f8c8d;'>STANDBY</span>";
                    addIoTLog("MQTT_PUB", "Topic: agri/pump/01/set -> Payload: {state: OFF}");
                    addIoTLog("MQTT_SUB", "Ack: Motor Stopped.");
                    
                    // Send Browser Notification
                    sendPushNotification("Smart Motor Stopped", "Pump #1 has been switched OFF.");
                }
            }, 800); // 800ms network delay simulation
        }
        
        // --- ADDED: Timer Function (Auto Mode function removed) ---
        
        function startTimer() {
            if(isMotorOn) {
                alert("Motor is already running! Please stop it first.");
                return;
            }
            
            const seconds = prompt("Enter timer duration (in seconds):", "10");
            if (seconds && !isNaN(seconds)) {
                addIoTLog("TIMER", `Scheduled run for ${seconds}s.`);
                
                // Start Motor
                toggleSmartMotor(); 
                
                // Update button text countdown
                const btn = document.getElementById('btn-timer');
                let left = parseInt(seconds);
                btn.innerHTML = `Timer (${left}s)`;
                
                // Countdown Interval
                const countdown = setInterval(() => {
                    left--;
                    btn.innerHTML = `Timer (${left}s)`;
                    if (left <= 0) {
                        clearInterval(countdown);
                        btn.innerHTML = "Timer ⏱️";
                    }
                }, 1000);

                // Stop Logic
                setTimeout(() => {
                    if (isMotorOn) toggleSmartMotor(); // Turn off
                    addIoTLog("TIMER", "Timer finished. Cycle Complete.");
                }, seconds * 1000);
            }
        }

        // --- NEW CHATBOT & AI FUNCTIONS ---
        
        // 1. Populate Full 7-Crop Tables (Yield/Schedules)
        function renderFullCropTables() {
            const cropData = [
                { name: 'Wheat', yield: '45 Q/ha', conf: '92%' },
                { name: 'Rice', yield: '55 Q/ha', conf: '89%' },
                { name: 'Maize', yield: '60 Q/ha', conf: '90%' },
                { name: 'Cotton', yield: '25 Q/ha', conf: '85%' },
                { name: 'Sugarcane', yield: '80 Ton/ha', conf: '94%' },
                { name: 'Soybean', yield: '20 Q/ha', conf: '88%' },
                { name: 'Potato', yield: '25 Ton/ha', conf: '91%' }
            ];
            
            const yieldTableBody = document.querySelector('#yield-prediction-table tbody');
            if (yieldTableBody) {
                let html = '';
                cropData.forEach(c => {
                    html += `<tr><td>${c.name}</td><td style="font-weight: bold; color: #00796b;">${c.yield}</td><td>${c.conf}</td></tr>`;
                });
                yieldTableBody.innerHTML = html;
            }
        }

        // 2. Multilingual Support Logic (Mocked)
        function toggleLanguageMenu() {
            document.getElementById('language-dropdown').classList.toggle('show');
        }

        function setLanguage(lang) {
            // Logic to change site content based on lang code
            const h1 = document.querySelector('.page-container h1');
            if(lang === 'hi' && h1) h1.innerHTML = "✔ डैशबोर्ड";
            else if(lang === 'kn' && h1) h1.innerHTML = "✔ ಡ್ಯಾಶ್‌ಬೋರ್ಡ್";
            else if(h1) h1.innerHTML = "✔ Dashboard";
            
            // Close menu
            document.getElementById('language-dropdown').classList.remove('show');
        }

        function sendChatQuery(textInput = null) {
            const inputField = document.getElementById('chat-input-field');
            const query = textInput || inputField.value.trim();
            
            if (!query) return;

            // 1. Add User Message
            addMessage('user', query);
            inputField.value = '';

            // 2. Show Typing Indicator
            const typingId = showTypingIndicator();

            // 3. Simulate AI Delay & Response
            setTimeout(() => {
                removeTypingIndicator(typingId);
                const response = generateMockResponse(query);
                addMessage('bot', response);
            }, 1200);
        }

        function addMessage(sender, htmlContent) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `message ${sender}-message`;
            
            let avatar = sender === 'bot' ? '<div class="avatar bot-avatar">🤖</div>' : '';
            let userAvatar = sender === 'user' ? '<div class="avatar user-avatar">👤</div>' : '';
            let bubble = `<div class="${sender}-bubble">${htmlContent}</div>`;
            
            div.innerHTML = sender === 'bot' ? (avatar + bubble) : (bubble + userAvatar);
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function showTypingIndicator() {
            const id = 'typing-' + Date.now();
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'message bot-message';
            div.id = id;
            div.innerHTML = `
                <div class="avatar bot-avatar">🤖</div>
                <div class="bot-bubble">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                    </div>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        function removeTypingIndicator(id) {
            const el = document.getElementById(id);
            if(el) el.remove();
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendChatQuery();
        }

        function startVoiceInput() {
            const btn = document.querySelector('.icon-btn');
            btn.style.color = 'red';
            btn.classList.add('animate-pulse');
            
            // Simulating listening
            setTimeout(() => {
                alert("🎤 Listening... 'What is the fertilizer for Sugarcane?' detected.");
                sendChatQuery('What is the fertilizer for Sugarcane?');
                btn.style.color = '#555';
                btn.classList.remove('animate-pulse');
            }, 1500);
        }

        // UPDATED: AI Logic for 7 Crops, Soil, Pests, and Schemes
        function generateMockResponse(query) {
            const q = query.toLowerCase();
            
            // 1. SCHEMES SUPPORT
            if (q.includes('scheme') || q.includes('subsidy') || q.includes('govt') || q.includes('loan')) {
                return `
                    <strong>📜 Government Schemes (Karnataka/India):</strong>
                    <ul style="padding-left:20px; margin:5px 0;">
                        <li><strong>PM-Kisan Samman Nidhi:</strong> ₹6000/year financial support.</li>
                        <li><strong>PM Fasal Bima Yojana (PMFBY):</strong> Crop insurance against natural calamities.</li>
                        <li><strong>Rythu Bandhu (Similar):</strong> State investment support for agriculture.</li>
                        <li><strong>Kisan Credit Card (KCC):</strong> Low-interest loans for farmers.</li>
                    </ul>
                    <a href="#" style="color:#3498db;">Apply on Official Portal</a>
                `;
            }

            // 2. FERTILIZER PLANS (7 Crops)
            if (q.includes('fertilizer') || q.includes('nutrient') || q.includes('npk')) {
                if (q.includes('sugarcane')) return `<strong>🎋 Sugarcane Fertilizer Plan:</strong><br>High NPK requirement.<br><ul><li>Basal: 50kg DAP + 50kg MOP/acre.</li><li>Top Dressing (90 days): 100kg Urea.</li><li>Micro: Zinc Sulphate 10kg/acre.</li></ul>`;
                if (q.includes('potato')) return `<strong>🥔 Potato Fertilizer Plan:</strong><br>Needs high Potash for tuber size.<br><ul><li>NPK Ratio: 120:60:120 kg/ha.</li><li>Split Nitrogen: 50% at planting, 50% at earthing up.</li></ul>`;
                if (q.includes('cotton')) return `<strong>☁️ Cotton Fertilizer Plan:</strong><br><ul><li>NPK: 120:60:60 kg/ha.</li><li>Foliar Spray: Magnesium Sulphate + Urea during flowering.</li></ul>`;
                if (q.includes('soybean')) return `<strong>🌱 Soybean Fertilizer Plan:</strong><br>Legume crop, fixes own Nitrogen.<br><ul><li>Basal: 20:60:40 (NPK) kg/ha.</li><li>Add Sulphur (Gypsum) for oil content.</li></ul>`;
                if (q.includes('rice') || q.includes('paddy')) return `<strong>🌾 Rice Fertilizer Plan:</strong><br><ul><li>Basal: DAP 50kg + MOP 25kg/acre.</li><li>Top Dressing: Urea at tillering & panicle initiation.</li><li>Zinc is critical for Rice.</li></ul>`;
                if (q.includes('maize')) return `<strong>🌽 Maize Fertilizer Plan:</strong><br><ul><li>Heavy feeder. NPK 120:60:40 kg/ha.</li><li>Zinc deficiency causes 'White Bud'. Apply ZnSO4.</li></ul>`;
                if (q.includes('wheat')) return `<strong>🌾 Wheat Fertilizer Plan:</strong><br><ul><li>NPK 100:50:40 kg/ha.</li><li>Irrigate after fertilizer application (CRI stage).</li></ul>`;
                
                return `<strong>🌱 General Fertilizer Tip:</strong><br>Always perform a <strong>Soil Health Card</strong> test before applying fertilizers. For clay soil, apply Nitrogen in splits. For red soil, add organic compost.`;
            }

            // 3. PEST IDENTIFICATION (7 Crops)
            if (q.includes('pest') || q.includes('disease') || q.includes('insect') || q.includes('worm')) {
                if (q.includes('sugarcane')) return `<strong>🐛 Sugarcane Pests:</strong><br>1. <strong>Early Shoot Borer:</strong> Dead hearts in young crop. <em>Remedy:</em> Chlorpyriphos.<br>2. <strong>Woolly Aphid:</strong> White coating on leaves. <em>Remedy:</em> Acephate spray.`;
                if (q.includes('cotton') || q.includes('bollworm')) return `<strong>🐛 Cotton Pest: Pink Bollworm</strong><br>Larvae damage bolls internally.<br><strong>Solution:</strong> Pheromone traps (5/acre) + Profenofos spray.`;
                if (q.includes('potato')) return `<strong>🥔 Potato Pest: Tuber Moth</strong><br>Mines into leaves and tubers.<br><strong>Solution:</strong> Proper earthing up + Quinalphos spray.`;
                if (q.includes('soybean')) return `<strong>🌱 Soybean Pest: Stem Fly/Girdle Beetle</strong><br><strong>Solution:</strong> Seed treatment with Thiamethoxam.`;
                if (q.includes('rice') || q.includes('stem borer')) return `<strong>🌾 Rice Pest: Stem Borer</strong><br>Causes 'Dead Heart'.<br><strong>Solution:</strong> Cartap Hydrochloride 4G granules.`;
                if (q.includes('maize')) return `<strong>🌽 Maize Pest: Fall Armyworm</strong><br>Serious leaf damage.<br><strong>Solution:</strong> Emamectin Benzoate spray at early stage.`;
                if (q.includes('wheat') || q.includes('rust')) return `<strong>🌾 Wheat Disease: Yellow Rust</strong><br>Yellow powder on leaves.<br><strong>Solution:</strong> Propiconazole fungicide.`;
                
                return `<strong>🔍 Pest ID:</strong> Please specify the crop name (e.g., "Cotton pest", "Potato disease") for a specific diagnosis.`;
            }

            // 4. PRICE / MARKET UPDATES
            if (q.includes('price') || q.includes('market')) {
                return `
                    <strong>📉 Real-Time Mandi Prices (Karnataka):</strong>
                    <table class="chat-table">
                        <tr><th>Crop</th><th>Price (₹/Q)</th><th>Trend</th></tr>
                        <tr><td>Cotton</td><td>₹6,800</td><td><span style="color:green">▲ +2%</span></td></tr>
                        <tr><td>Soybean</td><td>₹4,200</td><td><span style="color:red">▼ -1%</span></td></tr>
                        <tr><td>Tur/Arhar</td><td>₹9,500</td><td><span style="color:green">▲ +5%</span></td></tr>
                        <tr><td>Maize</td><td>₹2,100</td><td><span style="color:orange">● Stable</span></td></tr>
                    </table>
                `;
            }

            // 5. SOIL TIPS
            if (q.includes('soil')) {
                if (q.includes('black')) return `<strong>⚫ Black Soil Tips:</strong> Good for Cotton/Sugarcane. Retains moisture but cracks when dry. Use mulch.`;
                if (q.includes('red')) return `<strong>🔴 Red Soil Tips:</strong> Often acidic. Use Lime. Good for Groundnut/Potato. Needs frequent irrigation.`;
                return `<strong>🌱 Soil Advice:</strong> Maintain organic carbon by adding FYM. Rotate crops to preserve nutrients.`;
            }

            return `I can help with <strong>Fertilizers, Pests, Market Prices, and Schemes</strong> for 7 major crops (Rice, Wheat, Maize, Cotton, Sugarcane, Soybean, Potato).<br><br>Try asking: <em>"Fertilizer for Sugarcane"</em> or <em>"Cotton Pests"</em>.`;
        }

        function addIoTLog(type, msg) {
            const terminal = document.getElementById('iot-logs');
            const time = new Date().toLocaleTimeString();
            const color = type === 'MQTT_PUB' ? '#3498db' : (type === 'MQTT_SUB' ? '#f1c40f' : (type === 'AUTO' || type === 'TIMER' ? '#e67e22' : '#2ecc71'));
            
            const html = `<div class="log-line">
                <span class="log-timestamp">[${time}]</span>
                <span style="color:${color}; font-weight:bold;">${type}:</span> ${msg}
            </div>`;
            
            terminal.innerHTML = html + terminal.innerHTML;
        }

        function updateSignalStrength() {
            // Randomly fluctuate signal bars to look real
            setInterval(() => {
                const bars = document.querySelectorAll('.signal-bar');
                const strength = Math.floor(Math.random() * 2) + 2; // 2 or 3 or 4
                bars.forEach((bar, idx) => {
                    if(idx < strength) bar.classList.add('active');
                    else bar.classList.remove('active');
                });
            }, 3000);
        }

        // --- NEW: Real Notification Logic & Simulation ---
        function enableNotifications() {
            if (!("Notification" in window)) {
                alert("This browser does not support desktop notifications");
            } else if (Notification.permission === "granted") {
                sendPushNotification("System Ready", "Notifications are already enabled!");
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(function (permission) {
                    if (permission === "granted") {
                        sendPushNotification("Success!", "You will now receive critical farm alerts.");
                    }
                });
            }
        }

        function sendPushNotification(title, body) {
            console.log(`[SMS GATEWAY MOCK] Sending SMS to User: ${title} - ${body}`);
            if (Notification.permission === "granted") {
                new Notification(title, {
                    body: body,
                    icon: "https://cdn-icons-png.flaticon.com/512/1822/1822045.png"
                });
            }
        }

        // Background Simulation for Environmental Alerts
        function startEnvironmentalSimulation() {
            setInterval(() => {
                // Random event generator
                const r = Math.random();
                if (r > 0.95) {
                    sendPushNotification("⚠️ High Temperature Alert", "Current temp 38°C. Crop heat stress risk.");
                } else if (r > 0.90 && r < 0.95) {
                    sendPushNotification("💧 Low Soil Moisture", "Moisture < 20%. Automatic irrigation may trigger soon.");
                } else if (r > 0.85 && r < 0.90) {
                    sendPushNotification("🌧️ Rain Forecast", "Heavy rain expected in 2 hours. Delay irrigation.");
                }
            }, 30000); // Check every 30 seconds for demo purposes
        }

        // --- 10. INITIALIZATION & CHARTS ---
        document.addEventListener('DOMContentLoaded', () => {
            checkLoginState();
            
            if ('{{ current_page }}' === 'Marketplace') {
                renderActiveListings();
                renderRentals(); 
                const sellForm = document.getElementById('sell-crop-form');
                if (sellForm) {
                    sellForm.addEventListener('submit', window.postCropListing);
                }
            }
            
            if ('{{ current_page }}' === 'Dashboard') {
                 if(typeof initDashboardWeather === 'function') initDashboardWeather();
            }
            
            // Manually populate yield table for Crop Management page if it exists
            if (document.querySelector('.data-table')) {
                 renderFullCropTables();
            }

            if ('{{ current_page }}' === 'IoT Sensors') {
                // Initialize IoT Logic
                renderIoTState();

                const ctx = document.getElementById('iotChart');
                if(ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['10:00', '10:05', '10:10', '10:15', '10:20', '10:25'],
                            datasets: [{
                                label: 'Soil Moisture (%)',
                                data: [45, 46, 44, 42, 43, 45],
                                borderColor: '#1e88e5',
                                tension: 0.4
                            }, {
                                label: 'Temp (°C)',
                                data: [28, 29, 30, 31, 30, 29],
                                borderColor: '#e74c3c',
                                tension: 0.4
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
            }
        });
    </script>
</head>
<body>

    <div id="bank-details-modal" class="payment-modal-overlay">
        <div class="payment-modal" style="max-width:400px;">
            <h3>🏦 Bank Account Details</h3>
            <p style="font-size:0.9em; color:#666; margin-bottom:15px;">Enter details to receive payments from buyers.</p>
            
            <label>Account Holder Name</label>
            <input type="text" id="bank-name" placeholder="e.g. Rahul Kumar">
            
            <label style="margin-top:10px;">Account Number</label>
            <input type="password" id="bank-num" placeholder="XXXXXXXX1234">
            
            <label style="margin-top:10px;">IFSC Code</label>
            <input type="text" id="bank-ifsc" placeholder="HDFC0001234">
            
            <button onclick="saveBankDetails()" style="background-color:#3498db; margin-top:20px;">Save Details</button>
            <button class="close-modal-btn" onclick="document.getElementById('bank-details-modal').style.display='none'" style="background-color:#95a5a6 !important;">Cancel</button>
        </div>
    </div>

    <div id="login-modal" class="payment-modal-overlay">
        <div class="payment-modal" style="max-width:350px;">
            
            <div id="login-form">
                <h3 style="margin-bottom:20px;">User Login</h3>
                <label>Username</label>
                <input type="text" id="login-username" placeholder="Enter username">
                <label style="margin-top:15px;">Password</label>
                <input type="password" id="login-password" placeholder="Enter password">
                <button onclick="performLogin()" style="margin-top:25px; background-color:#2ecc71;">Login</button>
                
                <div class="auth-toggle-text" onclick="toggleAuthMode('register')">
                    Don't have an account? <strong>Register here</strong>
                </div>
            </div>

            <div id="register-form" class="auth-form-hidden">
                <h3 style="margin-bottom:20px; color:#e67e22;">Create Account</h3>
                <label>Username</label>
                <input type="text" id="reg-username" placeholder="Choose a username">
                <label style="margin-top:15px;">Email Address</label>
                <input type="email" id="reg-email" placeholder="name@example.com">
                <label style="margin-top:15px;">Password</label>
                <input type="password" id="reg-password" placeholder="Create password">
                <button onclick="performRegister()" style="margin-top:25px; background-color:#e67e22;">Register</button>
                <div class="auth-toggle-text" onclick="toggleAuthMode('login')">
                    Already have an account? <strong>Login here</strong>
                </div>
            </div>
            
            <button class="close-modal-btn" onclick="document.getElementById('login-modal').style.display='none'" style="background-color:#95a5a6 !important; margin-top:10px;">Cancel</button>
        </div>
    </div>

    <div id="payment-modal-overlay" class="payment-modal-overlay">
        <div class="payment-modal">
            <h3>Secure Payment Gateway</h3>
            
            <div id="step-1" class="payment-step active">
                <p><strong>Payment For:</strong> <br><span id="pay-desc-text" style="color:#555;"></span></p>
                <p style="font-size:1.5em; color:#27ae60; font-weight:bold; margin:10px 0;">₹<span id="pay-amount-preview"></span></p>
                <p style="font-size:0.9em; color:#777; margin-bottom:5px;">Select Payment Method:</p>
                <button onclick="showQrScan()" style="background-color:#34495e; width:100%;">📷 Scan QR Code</button>
                <p style="text-align:center; font-size:0.8em; color:#888; margin-top:10px;">Or use Card / Net Banking (Mock)</p>
            </div>

            <div id="step-2" class="payment-step">
                <p style="text-align:center;">Align QR Code within frame</p>
                <div class="qr-code-box">
                    <div class="qr-scanner-line"></div>
                </div>
                <p style="text-align:center; color:#2980b9;">Scanning Merchant Details...</p>
            </div>

            <div id="step-3" class="payment-step">
                <label style="text-align:left;">Total Payable Amount</label>
                <input type="text" id="final-amount-input" readonly style="background:#f9f9f9; font-weight:bold; color:#333; font-size:1.1em;">
                <label style="text-align:left; margin-top:15px;">Enter UPI PIN</label>
                <input type="password" id="upi-pin-input" placeholder="● ● ● ●" style="text-align:center; letter-spacing:5px; font-size:1.5em; display:block; width:50%; margin:0 auto;">
                <button id="pay-btn-final" onclick="verifyPinAndComplete()" style="margin-top:20px;">Verify PIN & Pay</button>
            </div>

            <button class="close-modal-btn" onclick="document.getElementById('payment-modal-overlay').style.display='none'">Cancel Transaction</button>
        </div>
    </div>

    <div id="catalog-modal" class="payment-modal-overlay">
        <div class="payment-modal" style="max-width:450px;">
            <h3>Agri-Input Catalog</h3>
            <p style="font-size:0.9em; color:#666; margin-bottom:10px;">Browse trusted seeds, fertilizers and chemicals.</p>
            <div id="catalog-list-container" class="catalog-list"></div>
            <button class="close-modal-btn" onclick="document.getElementById('catalog-modal').style.display='none'" style="background-color:#34495e !important;">Close Catalog</button>
        </div>
    </div>

    <div id="cart-modal" class="payment-modal-overlay">
        <div class="payment-modal" style="max-width:400px;">
            <h3>Your Shopping Cart</h3>
            <div id="cart-list-container" class="catalog-list"></div>
            <div style="border-top:1px solid #eee; margin-top:15px; padding-top:10px; text-align:right;">
                <strong>Total: ₹<span id="cart-total-price">0</span></strong>
            </div>
            <button id="btn-checkout-cart" onclick="checkoutCart()" class="checkout-btn">Checkout Now</button>
            <button class="close-modal-btn" onclick="document.getElementById('cart-modal').style.display='none'" style="background-color:#e74c3c !important;">Close</button>
        </div>
    </div>

    <div id="iot-pairing-modal" class="payment-modal-overlay">
        <div class="payment-modal" style="max-width: 400px; text-align: center;">
            <h3>Connect Smart Device</h3>
            <p style="margin-bottom: 20px; color: #666;">Align the QR code located on your Smart Motor Starter.</p>
            
            <div class="qr-code-box" style="margin: 0 auto 20px auto;">
                <div id="iot-scan-line" class="qr-scanner-line"></div>
            </div>
            
            <p id="iot-scan-status" style="font-weight: bold; color: #555; margin-bottom: 20px;">Initializing Camera...</p>
            
            <button onclick="simulatePairingProcess()" style="background-color: #34495e;">Simulate Scan</button>
            <button class="close-modal-btn" onclick="document.getElementById('iot-pairing-modal').style.display='none'">Cancel</button>
        </div>
    </div>

    <div class="wrapper">
        <div class="sidebar">
            <div class="sidebar-header">AgriSense AI</div>
            <nav>
                {% for item in menu %}
                    <a href="{{ url_for('dashboard', page=item, lang=lang) }}" 
                       class="nav-item {% if current_page == item %}active{% endif %}">
                        <span class="icon"></span> {{ item }}
                    </a>
                {% endfor %}
                
                <a href="{{ url_for('dashboard', page='Analytics', lang=lang) }}" 
                   class="nav-item {% if current_page == 'Analytics' %}active{% endif %}">
                   <span class="icon"></span> 📊 Analytics
                </a>
            </nav>
            
            <div style="padding: 20px; margin-top: auto;">
                 <div id="user-info-panel" style="display:none; padding: 0 5px; margin-bottom: 10px;">
                     <div style="font-weight:bold; color:#1abc9c;">👤 <span id="display-username">User</span></div>
                     <div style="font-size:0.75em; color:#aaa;">Last Login: <br><span id="display-last-login"></span></div>
                 </div>
                 <button id="auth-btn" onclick="handleAuthClick()" style="background-color: #e67e22; width: 100%; padding: 10px; font-size: 0.9em;">🔑 Login / Sign Up</button>
            </div>

            <div style="padding: 20px; font-size: 0.8em; color: #95a5a6; border-top: 1px solid #34495e;">
                <p>System Version: 3.3 (Final)</p>
                <p>Technology Stack:</p>
                <ul style="list-style-type: none; padding-left: 10px; margin-top: 5px;">
                    <li>- **AI/ML:** TensorFlow / PyTorch (CNN models)</li>
                    <li>- **Vision:** OpenCV for image analysis</li>
                    <li>- **IoT:** ESP32 / MQTT broker (Mosquitto)</li>
                    <li>- **Database:** PostgreSQL / MongoDB</li> 
                </ul>
            </div>
        </div>

        <div class="main-content">
            
            <div id="login-barrier" class="login-barrier">
                <span class="barrier-icon">👨‍🌾</span> 
                <div class="barrier-title">Access Restricted</div>
                <p class="barrier-desc">Please login to your account to access advanced agricultural features, real-time data, and marketplace tools.</p>
                <button onclick="handleAuthClick()" class="barrier-btn">Login to Continue</button>
            </div>

            <div id="feature-content">
                <div class="top-header-bar">
                    <div style="font-size:0.9em; color:#7f8c8d;">{{ current_page }}</div>
                    
                    <div style="display:flex; align-items:center;">
                        <div id="header-welcome-msg" class="welcome-msg">Welcome!</div>
                        
                        <button onclick="enableNotifications()" class="header-icon-btn" title="Enable Notifications">🔔</button>

                        <div class="language-selector-container">
                            <button onclick="toggleLanguageMenu()" class="header-icon-btn" title="Change Language">🌐</button>
                            <div id="language-dropdown" class="lang-dropdown">
                                <div onclick="setLanguage('en')">English</div>
                                <div onclick="setLanguage('hi')">हिन्दी (Hindi)</div>
                                <div onclick="setLanguage('kn')">ಕನ್ನಡ (Kannada)</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if current_page == 'Dashboard' %}
                    <div class="page-container">
                        <h1>✔ Dashboard</h1>
                        <p style="color: #555;">AI-driven insights for proactive decision-making.</p>
                        
                        <div class="alert-box alert-{{ irrigation_alert.type }}">
                            **💧 IRRIGATION ALERT:** {{ irrigation_alert.message }}
                        </div>

                        <div id="dashboard-live-weather-container" 
                             class="dashboard-weather-card mb-5 flex items-center justify-center mx-auto" 
                             style="max-width: 650px; margin: 0 auto 25px auto;">
                            
                            <div class="flex items-center justify-center">
                                <svg class="animate-spin h-6 w-6 mr-3 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <p class="text-gray-600">Fetching live weather data...</p>
                            </div>
                        </div>
                        
                        <script>
                            tailwind.config = { theme: { extend: { colors: { 'icon-sun': '#FFD700', 'icon-rain': '#1E90FF', 'icon-cloud': '#B0C4DE', }, fontFamily: { sans: ['Inter', 'sans-serif'], }, }, } }

                            function renderDashboardWeatherCard(data) {
                                const container = document.getElementById('dashboard-live-weather-container');
                                if (!container) return;
                                
                                // UPDATED HTML: 
                                // 1. Icon: w-12 h-12 (48px) and text-3xl
                                // 2. Location Name: text-sm (Increased)
                                // 3. Humidity/Wind: text-[8px] (Decreased)
                                const htmlContent = `
                                    <div class="w-full flex items-center justify-between">
                                        <div class="flex items-center space-x-2">
                                            <div class="dashboard-weather-icon bg-yellow-600 flex-shrink-0 w-12 h-12" style="width: 48px; height: 48px;">
                                                <span class="text-3xl leading-none">${data.icon}</span>
                                            </div>
                                            <div class="truncate">
                                                <h3 class="text-sm font-bold text-gray-800 truncate">${data.location}</h3>
                                                <p class="text-[10px] text-gray-600">${data.condition}</p>
                                            </div>
                                        </div>
                                        
                                        <div class="text-right flex-shrink-0">
                                            <p class="text-lg font-extrabold text-blue-800">${data.temp}°C</p>
                                            <div class="mt-0 text-gray-500 text-[8px]">
                                                <p>Humidity: ${data.humidity}%</p>
                                                <p>Wind: ${data.wind} km/h</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                container.innerHTML = htmlContent;
                                container.classList.add('transition', 'duration-300', 'hover:shadow-lg');
                                container.classList.remove('justify-center', 'items-center', 'min-height-[70px]');
                            }
                            
                            async function initDashboardWeather() {
                                const liveData = await getAccurateLiveWeather();
                                renderDashboardWeatherCard(liveData);
                            }
                        </script>
                        
                        <div class="content-grid">
                            <div class="input-form content-section">
                                <h2>🌱 {{ text.heading }}</h2>
                                <form method="POST" action="{{ url_for('dashboard', page='Dashboard', lang=lang) }}">
                                    <label for="nitrogen">Nitrogen (N) (kg/ha)</label>
                                    <input type="number" step="any" id="nitrogen" name="nitrogen" required value="90">
                                    <label for="phosphorus">Phosphorus (P) (kg/ha)</label>
                                    <input type="number" step="any" id="phosphorus" name="phosphorus" required value="42">
                                    <label for="potassium">Potassium (K) (kg/ha)</label>
                                    <input type="number" step="any" id="potassium" name="potassium" required value="43">
                                    <label for="ph">pH Value (3.0 - 10.0)</label>
                                    <input type="number" step="any" id="ph" name="ph" required value="6.5">
                                    <button type="submit" class="recommend-btn">{{ text.recommend_btn }}</button>
                                </form>

                                <div class="placeholder-box" style="background-color: #fff3e0; border: 1px dashed #ffcc80;">
                                    <p>📸 **Leaf Disease Detection (CNN Module)**</p>
                                    <p style="font-size: small; color: #d35400;">*Uses **TensorFlow/PyTorch** model simulation for analysis.*</p>
                                    
                                    <form method="POST" action="{{ url_for('detect_disease', lang=lang) }}" enctype="multipart/form-data">
                                        <label for="leaf_image" style="margin-top: 10px; font-weight: normal; color: #333;">Upload JPG/PNG of Leaf:</label>
                                        <input type="file" id="leaf_image" name="leaf_image" accept="image/png, image/jpeg" required 
                                            style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                                        
                                        <button type="submit" class="detect-btn">
                                            Upload Leaf Image & Detect
                                        </button>
                                    </form>
                                </div>
                                
                                <div class="placeholder-box" style="background-color: #e8f5e9; border: 1px dashed #a5d6a7;">
                                    <p>📡 **IoT Sensor Integration & Smart Irrigation Control**</p>
                                    <p style="font-size: small; color: #004d40;">*Future: Data ingestion via **MQTT broker (Mosquitto)** from **ESP32/Raspberry Pi** sensors.*</p>
                                </div>
                            </div>

                            <div class="results-section content-section">
                                <h2>✅ {{ text.result_heading }}</h2>

                                {% if disease_result %}
                                    <div style="background-color: #ffe0b2; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                        <strong>🌿 DISEASE DIAGNOSIS:</strong> 
                                        <span class="crop-value" style="color: #b33a00;">{{ disease_result.disease }}</span>
                                        <p style="margin-top: 5px;">Confidence: **{{ disease_result.confidence }}** | Severity: **{{ disease_result.severity }}** | Model: *{{ disease_result.model_used }}*</p>
                                        
                                        <div style="margin-top: 10px; padding: 8px; border-top: 1px solid #f9e2c6;">
                                            <p style="font-weight: bold;">Pesticide Quantity:</p>
                                            <span style="font-size: 1.1em; color: #cc6600;">{{ disease_result.pesticide_qty }}</span>
                                        </div>
                                        <p style="font-size: 0.85em; color: #555; margin-top: 5px;">*Treatment Suggestion: {{ disease_result.remedy }}*</p>
                                    </div>
                                {% endif %}
                                
                                {% if result %}
                                    <div class="result-item"><strong>{{ text.soil_health }}:</strong> <span class="result-value" style="color: #388e3c;">{{ result.soil_health }}</span></div>
                                    <div class="result-item"><strong>{{ text.crop }} (ML):</strong> <span class="crop-value">{{ result.crop | upper }}</span></div>
                                    <div class="result-item">
                                        <strong>Confidence Scores:</strong>
                                        <ul style="list-style-type: none; padding-left: 0; font-size: 0.9em;">
                                            {% for item in result.top_recommendations %}
                                                <li style="background-color: #e0f7fa; margin-top: 2px; padding: 3px; border-left: 3px solid #00bcd4;">{{ item.crop }}: **{{ item.confidence }}**</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    <div class="result-item"><strong>{{ text.fert }}:</strong> <span class="result-value">{{ result.fertilizer }}</span></div>
                                    <div class="result-item"><strong>{{ text.crop_water }}:</strong> <span class="result-value" style="font-size: 1em; color: #1e88e5;">{{ result.water_req }}</span></div>
                                    <div class="result-item"><strong>{{ text.price_forecast }}:</strong> <span class="result-value" style="font-size: 1em; color: #004d40;">{{ result.price_forecast }}</span></div>
                                    
                                    <a href="{{ url_for('generate_report', lang=lang, 
                                        N=result.N, P=result.P, K=result.K, pH=result.pH, 
                                        soil_health=result.soil_health, crop=result.crop, 
                                        fertilizer=result.fertilizer, water_req=result.water_req, 
                                        price_forecast=result.price_forecast, date='N/A') }}" 
                                        class="report-link">
                                        Generate **Comprehensive Soil Report** (PDF)
                                    </a>
                                    
                                {% else %}
                                    <p style="text-align: center; padding: 20px; color: #7f8c8d;">Enter soil data on the left to run the analysis.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                {% elif current_page == 'Weather' %}
                    <div class="page-container">
                        <h1>✔ Weather Forecast</h1>
                        <p style="color: #555;">Localized 7-day precision forecast for your farm location.</p>
                        
                        <div class="live-weather-card">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <h2>Raichur, Karnataka</h2>
                                    <div style="font-size: 1.2em; opacity: 0.8;">Mostly Sunny</div>
                                    <div style="font-size: 0.9em; color: #aaa;">Updated: Just now</div>
                                </div>
                                <div class="temp-icon">34°C ☀️</div>
                            </div>
                            
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <strong>60%</strong>
                                    <span>Humidity</span>
                                </div>
                                <div class="detail-item">
                                    <strong>12 km/h</strong>
                                    <span>Wind Speed</span>
                                </div>
                                <div class="detail-item">
                                    <strong>0 mm</strong>
                                    <span>Precipitation</span>
                                </div>
                            </div>
                        </div>

                        <h3 style="margin-top:30px; color:#2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px;">7-Day Outlook</h3>
                        <div class="content-grid" style="grid-template-columns: repeat(4, 1fr); gap: 15px;">
                            <div class="forecast-card">
                                <div class="day">Tomorrow</div>
                                <div class="temp">35°C ☀️</div>
                                <div style="font-size:0.8em; color:#7f8c8d;">Clear Sky</div>
                            </div>
                            <div class="forecast-card">
                                <div class="day">Friday</div>
                                <div class="temp">33°C ⛅</div>
                                <div style="font-size:0.8em; color:#7f8c8d;">Partly Cloudy</div>
                            </div>
                            <div class="forecast-card">
                                <div class="day">Saturday</div>
                                <div class="temp">31°C 🌧️</div>
                                <div style="font-size:0.8em; color:#7f8c8d;">Light Rain</div>
                            </div>
                            <div class="forecast-card">
                                <div class="day">Sunday</div>
                                <div class="temp">30°C 🌧️</div>
                                <div style="font-size:0.8em; color:#7f8c8d;">Thunderstorm</div>
                            </div>
                        </div>
                        
                        <div class="alert-box alert-medium" style="margin-top: 25px;">
                            ⚠️ <strong>Farming Advisory:</strong> Light rain expected on Saturday. Complete spraying activities by Friday evening.
                        </div>
                    </div>

                {% elif current_page == 'Crop Management' %}
                    <div class="page-container">
                        <h1>✔ Crop Management System</h1>
                        <p style="color: #555;">Manage active crop lifecycle, schedules, and predictions.</p>

                        {% if request.args.get('crop_status') %}
                            <div class="alert-box alert-low" style="margin-top: 10px; font-size: 0.9em;">
                                {{ request.args.get('crop_status') }}
                            </div>
                        {% endif %}

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px;">
                            
                            <div class="content-section" style="background-color: #f7fcfb;">
                                <h2>➕ Update Field Details</h2>
                                <form method="POST" action="{{ url_for('update_crop', lang=lang) }}">
                                    <label for="crop_name">Field and Crop Name (To Update)</label>
                                    <select id="crop_name" name="crop_name">
                                        {% for item in mock_crop_data %}
                                        <option>{{ item.name }}</option>
                                        {% endfor %}
                                    </select>
                                    
                                    <label for="date_planted">Date Planted</label>
                                    <input type="text" id="date_planted" name="date_planted" value="2025-10-15" onfocus="(this.type='date')">

                                    <label for="hectares">Area (Hectares)</label>
                                    <input type="number" step="0.1" id="hectares" name="hectares" value="5.5">

                                    <button type="submit" style="background-color: #3498db;">Save Crop Details</button>
                                </form>
                            </div>
                            
                            <div class="content-section" style="background-color: #fff8e1;">
                                <h2>📈 Yield Prediction (ARIMA/LSTM Mock)</h2>
                                <p style="margin-bottom: 10px; font-weight: bold; color: #7f8c8d;">Predictive Analysis Status:</p>
                                
                                <table class="data-table" id="yield-prediction-table" style="margin-top: 0;">
                                    <thead>
                                        <tr><th>Crop</th><th>Predicted Yield</th><th>Confidence</th></tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>

                                <button onclick="console.log('Running LSTM Model for Forecast...')" style="background-color: #f39c12;">Run Yield Forecast</button>
                            </div>
                        </div>

                        <h2 style="margin-top: 30px; border-bottom: 2px solid #ccc; padding-bottom: 10px;">📅 Schedules & Alerts</h2>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                            
                            <div class="content-section" style="background-color: #f0f4f7;">
                                <h3 style="color: #34495e;">Crop Growth Stages</h3>
                                <ul style="list-style-type: none; padding-left: 0; text-align: left; font-size: 0.9em;">
                                    {% for data in mock_crop_data %}
                                        {% for stage in data.schedules.growth_stages %}
                                            <li>{{ stage | safe }}</li>
                                        {% endfor %}
                                    {% endfor %}
                                </ul>
                            </div>
                            
                            <div class="content-section" style="background-color: #e3f2fd;">
                                <h3 style="color: #34495e;">Irrigation & Fertilizer Schedule</h3>
                                <table class="data-table" style="margin-top: 5px;">
                                    <thead>
                                        <tr><th>Next Action</th><th>Due Date</th></tr>
                                    </thead>
                                    <tbody>
                                        {% for data in mock_crop_data %}
                                            {% for schedule in data.schedules.irrigation_schedule %}
                                                <tr>
                                                    <td>{{ schedule.action }} ({{ data.name }})</td>
                                                    <td style="font-weight: bold; color: {{ 'red' if schedule.status == 'Critical' else 'black' }};">{{ schedule.date }}</td>
                                                </tr>
                                            {% endfor %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="content-section" style="background-color: #fef0f0;">
                                <h3 style="color: #34495e;">Disease & Pest Alerts</h3>
                                {% for data in mock_crop_data %}
                                    {% for alert in data.schedules.alerts %}
                                        <div class="alert-high" style="padding: 5px; margin-bottom: 5px; border-radius: 3px;">
                                            🚨 {{ alert }}
                                        </div>
                                    {% endfor %}
                                {% endfor %}
                                <div class="alert-low" style="padding: 5px; border-radius: 3px;">
                                    **System Check:** No new critical alerts detected.
                                </div>
                            </div>
                        </div>
                    </div>

                {% elif current_page == 'Smart Farm Map' %}
                    <div class="page-container">
                        <h1>✔ Smart Farm Map (Geo-Analytics)</h1>
                        <p>Real-time machine location and field health visualization using MapBox/Leaflet (Frontend).</p>
                        
                        <div style="background-color: #e6f0e6; padding: 20px; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-around; margin-bottom: 20px; padding: 10px; background-color: #fff; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <div style="text-align: center;"><div class="field-label">Field 1 Status</div><div class="field-value" style="color: #2ecc71;">Healthy</div></div>
                                <div style="text-align: center;"><div class="field-label">Field 2 Status</div><div class="field-value" style="color: #f39c12;">Warning (Low N)</div></div>
                                <div style="text-align: center;"><div class="field-label">Machine Status</div><div class="field-value" style="color: #3498db;">Seeder Active</div></div>
                            </div>

                            <svg viewBox="0 0 800 400" xmlns="http://www.w3.org/2000/svg" style="width: 100%; height: auto; border: 1px solid #ccc; border-radius: 6px; background-color: #f5f5f5;">
                                <rect x="50" y="50" width="250" height="150" fill="#2ecc71" opacity="0.7" rx="10" stroke="#1abc9c" stroke-width="3"/>
                                <text x="175" y="125" font-family="Arial" font-size="20" fill="white" text-anchor="middle">Field 1 (Wheat)</text>
                                
                                <polygon points="350,50 650,50 550,250 300,250" fill="#f39c12" opacity="0.7" stroke="#e67e22" stroke-width="3" rx="10"/>
                                <text x="475" y="150" font-family="Arial" font-size="20" fill="#fff" text-anchor="middle">Field 2 (Rice)</text>

                                <rect x="100" y="270" width="200" height="100" fill="#3498db" opacity="0.7" rx="10" stroke="#2980b9" stroke-width="3"/>
                                <text x="200" y="325" font-family="Arial" font-size="18" fill="white" text-anchor="middle">Field 3 (Maize)</text>

                                <circle cx="500" cy="100" r="15" fill="#e74c3c" stroke="white" stroke-width="2"/>
                                <text x="500" cy="130" font-family="Arial" font-size="14" fill="#2c3e50" text-anchor="middle">Tractor (Active)</text>
                                
                                <circle cx="100" cy="100" r="4" fill="white"/>
                                <circle cx="250" cy="180" r="4" fill="white"/>
                                <circle cx="400" cy="150" r="4" fill="white"/>
                            </svg>
                        </div>

                        <p style="margin-top: 20px; font-size: 0.9em; text-align: center;">**Geo-Analytics:** This visualization simulates real-time data overlays (color-coded health) and asset tracking (tractor location).</p>
                    </div>

                {% elif current_page == 'AI Recommendations' %}
                    <div class="page-container" style="background:transparent; box-shadow:none; padding:0;">
                        <div class="chat-window">
                            <div class="chat-header">
                                <div>
                                    <div style="font-weight: bold; font-size: 1.2em;">🤖 Agri-Assistant Pro</div>
                                    <div style="font-size: 0.8em; color: #bdc3c7;">● Online | Context: Karnataka Region</div>
                                </div>
                                <div style="font-size:1.5em; cursor:pointer;" title="Settings">⚙️</div>
                            </div>
                            
                            <div class="chat-messages" id="chat-messages">
                                <div class="message bot-message">
                                    <div class="avatar bot-avatar">🤖</div>
                                    <div class="bot-bubble">
                                        <strong>Namaste! 🙏</strong><br>
                                        I am your AI Agri-Advisor. I can analyze soil reports, predict market trends, and suggest pest remedies.<br><br>
                                        How can I assist you with your farm today?
                                    </div>
                                </div>
                            </div>
                            
                            <div class="quick-actions" id="quick-actions">
                                <button onclick="sendChatQuery('Market price for Rice?')" class="chip">💰 Rice Prices</button>
                                <button onclick="sendChatQuery('How to treat Yellow Rust?')" class="chip">🐛 Identify Pest</button>
                                <button onclick="sendChatQuery('Tips for Red Soil')" class="chip">🔴 Red Soil Tips</button>
                                <button onclick="sendChatQuery('Tips for Black Soil')" class="chip">⚫ Black Soil Tips</button>
                                <button onclick="sendChatQuery('Identify pest on Cotton')" class="chip">🔍 Cotton Pest</button>
                                <button onclick="sendChatQuery('List Govt Schemes')" class="chip">📜 Govt Schemes</button>
                            </div>

                            <div class="chat-input-area">
                                <button onclick="startVoiceInput()" class="icon-btn" title="Voice Input">🎤</button>
                                <input type="text" id="chat-input-field" placeholder="Ask about crops, diseases, or weather..." onkeypress="handleEnter(event)">
                                <button onclick="sendChatQuery()" class="send-btn">➤</button>
                            </div>
                        </div>
                    </div>

                {% elif current_page == 'IoT Sensors' %}
                    <div class="page-container">
                        <h1>✔ Smart IoT Controller</h1>
                        <p style="color: #555;">Manage your smart agricultural hardware via MQTT protocol.</p>
                        
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-top: 20px;">
                            
                            <div class="content-section" style="padding: 0;">
                                <h2 style="padding: 15px 20px; background-color: #f7f7f7; margin-bottom: 0;">Live Field Telemetry</h2>
                                <div style="padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div class="placeholder-box" style="background-color: #e3f2fd; border-left: 4px solid #1e88e5;">
                                        <div class="field-label">Soil Moisture</div>
                                        <div class="field-value" style="color: #1e88e5;">{{ iot_data.moisture }}</div>
                                    </div>
                                    <div class="placeholder-box" style="background-color: #fce4ac; border-left: 4px solid #c2185b;">
                                        <div class="field-label">Temperature</div>
                                        <div class="field-value" style="color: #c2185b;">{{ iot_data.temperature }}</div>
                                    </div>
                                    <div class="placeholder-box" style="background-color: #e0f2f1; border-left: 4px solid #009688;">
                                        <div class="field-label">Soil pH</div>
                                        <div class="field-value" style="color: #009688;">{{ iot_data.ph }}</div>
                                    </div>
                                    <div class="placeholder-box" style="background-color: #fff3e0; border-left: 4px solid #f57c00;">
                                        <div class="field-label">Light Intensity</div>
                                        <div class="field-value" style="color: #f57c00;">{{ iot_data.light }}</div>
                                    </div>
                                </div>
                                <div style="height: 250px; background-color: #fff; padding: 15px;">
                                    <canvas id="iotChart"></canvas>
                                </div>
                            </div>
                            
                            <div>
                                <div id="no-device-ui" class="content-section no-device-panel">
                                    <div style="font-size: 4em; margin-bottom: 10px;">🔌</div>
                                    <h3>No Smart Motor Connected</h3>
                                    <p style="color: #777; font-size: 0.9em; margin-bottom: 20px;">Scan the QR code on your pump starter to access remote features.</p>
                                    <button onclick="openPairingModal()" style="background-color: #34495e;">📷 Scan & Connect Device</button>
                                </div>

                                <div id="device-online-ui" class="iot-device-card device-online-panel">
                                    <div class="device-header">
                                        <div>
                                            <div style="font-weight: bold; font-size: 1.1em;">Pump Station #1</div>
                                            <div style="font-size: 0.8em; color: #2ecc71;">● Online (MQTT)</div>
                                        </div>
                                        <div class="signal-indicator" title="Signal Strength">
                                            <div class="signal-bar active" style="height: 6px;"></div>
                                            <div class="signal-bar active" style="height: 9px;"></div>
                                            <div class="signal-bar active" style="height: 12px;"></div>
                                            <div class="signal-bar" style="height: 15px;"></div>
                                        </div>
                                    </div>

                                    <div id="motor-icon-container" class="motor-icon-box">
                                        <span class="motor-fan">⚙️</span>
                                    </div>

                                    <div style="text-align: center;">
                                        <div id="motor-status-text" style="font-size: 1.1em; margin-bottom: 10px;">Status: <span style="color:#7f8c8d;">STANDBY</span></div>
                                        
                                        <div class="iot-switch-container">
                                            <div id="motor-toggle-btn" class="iot-toggle" onclick="toggleSmartMotor()"></div>
                                        </div>
                                        <p style="font-size: 0.8em; color: #999; margin-top: 5px;">Tap to Toggle ON/OFF</p>
                                    </div>

                                    <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

                                    <div style="display: flex; gap: 10px; justify-content: center;">
                                         <button id="btn-timer" onclick="startTimer()" style="margin: 0; font-size: 0.9em; background-color: #f39c12; width: auto; padding: 10px 20px;">Timer ⏱️</button>
                                    </div>
                                </div>

                                <h3 style="margin-top: 20px; color: #34495e;">Real-time Command Logs</h3>
                                <div id="iot-logs" class="iot-log-terminal">
                                    <div class="log-line"><span class="log-timestamp">[System]</span> Connection established via wss://mqtt.agrisense.io</div>
                                    <div class="log-line"><span class="log-timestamp">[System]</span> Listening for topic: agri/pump/01/#</div>
                                </div>
                            </div>
                        </div>
                    </div>

                {% elif current_page == 'Reports' %}
                    <div class="page-container">
                        <h1>✔ Comprehensive Agri-Reports</h1>
                        <p>Generate detailed insights on crop performance, soil health, and financial metrics.</p>
                        
                        <div class="report-grid-container">
                            <div class="report-card card-green">
                                <span class="report-icon">🌱</span>
                                <div>
                                    <div class="report-title">SOIL HEALTH REPORT</div>
                                    <div class="report-desc">Detailed N-P-K analysis and pH trends.</div>
                                </div>
                                <button class="report-download-btn btn-green" onclick="generateReport('soil')">Download PDF</button>
                            </div>

                            <div class="report-card card-orange">
                                <span class="report-icon">📉</span>
                                <div>
                                    <div class="report-title">YIELD ANALYSIS</div>
                                    <div class="report-desc">Predicted vs Actual yield performance.</div>
                                </div>
                                <button class="report-download-btn btn-orange" onclick="generateReport('yield')">Download PDF</button>
                            </div>

                            <div class="report-card card-blue">
                                <span class="report-icon">💰</span>
                                <div>
                                    <div class="report-title">Farm Cost & Profit Analysis</div>
                                    <div class="report-desc">Profit/Loss and expense tracking.</div>
                                </div>
                                <button class="report-download-btn btn-blue" onclick="generateReport('profit')">Download PDF</button>
                            </div>
                        </div>
                        
                        <div class="content-section" style="margin-top: 30px;">
                            <h2>📜 Live Transaction Log</h2>
                            <div id="live-report-preview">Loading recent activity...</div>
                            <button id="toggle-report-btn" onclick="toggleReportView()" class="show-more-btn" style="display:none;">Show Full Report Log</button>
                        </div>

                        <div class="custom-report-box">
                            <div class="custom-report-header">🗓️ CUSTOM REPORT GENERATOR</div>
                            <div class="cr-flex">
                                <div class="cr-group">
                                    <label class="cr-label">Start</label>
                                    <input type="date" id="cr-start" class="cr-input">
                                </div>
                                <div class="cr-group">
                                    <label class="cr-label">End</label>
                                    <input type="date" id="cr-end" class="cr-input">
                                </div>
                                <div class="cr-group">
                                    <label class="cr-label">Type</label>
                                    <select id="cr-type" class="cr-input">
                                        <option value="logs">Logs</option>
                                        <option value="audit">Audit</option>
                                        <option value="transactions">Transactions</option>
                                    </select>
                                </div>
                                <button class="cr-gen-btn" onclick="generateCustomReport()">Generate</button>
                            </div>
                        </div>

                        <h3 style="margin-top: 40px; color: #7f8c8d; font-size: 0.9em; text-transform: uppercase;">RECENT HISTORY</h3>
                    </div>

                {% elif current_page == 'Marketplace' %}
                    <div class="page-container">
                        <h1>✔ Marketplace & Rentals</h1>
                        <p style="color: #555;">Buy, Sell, and Rent agricultural resources with community integration.</p>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px;">
                            
                            <div class="content-section marketplace-card-sell">
                                <h2>🛒 Sell Crops (Post Listing)</h2>
                                <form onsubmit="postCropListing(event)" id="sell-crop-form">
                                    <label for="sell_crop">Crop / Commodity</label>
                                    <select id="sell_crop" name="sell_crop">
                                        <option>Wheat</option>
                                        <option>Rice (Basmati)</option>
                                        <option>Maize</option>
                                        <option>Cotton</option>
                                        <option>Sugarcane</option>
                                        <option>Soybean</option>
                                        <option>Potato</option>
                                    </select>
                                    <label for="quantity">Quantity (Quintal)</label>
                                    <input type="number" step="1" id="quantity" name="quantity" value="100">
                                    <label for="price">Expected Price (₹/Quintal)</label>
                                    <input type="number" step="10" id="price" name="price" value="2350">
                                    
                                    <div class="action-btn-group">
                                        <button type="submit" class="marketplace-btn-sell">Post Listing (Mock)</button>
                                        <button type="button" onclick="openBankModal()" class="bank-btn">🏦 Bank Settings</button>
                                    </div>
                                </form>
                            </div>
                            
                            <div class="content-section marketplace-card-buy">
                                <h2>📦 Active Crop Listings (Buy Now)</h2>
                                <table class="data-table" style="margin-top: 0;">
                                    <thead>
                                        <tr><th>Crop</th><th>Qty (Q)</th><th>Price</th><th>Seller</th><th>Action</th></tr>
                                    </thead>
                                    <tbody id="active-crop-listings-body">
                                        <tr><td colspan="5" style="text-align: center; color: #7f8c8d;">Loading listings...</td></tr>
                                    </tbody>
                                </table>
                                <div style="margin-top: 15px;">
                                    <button onclick="openCatalogModal()" class="marketplace-btn-buy" style="width: 48%;">Browse Full Catalog</button>
                                    <button onclick="openCartModal()" id="btn-view-cart" class="marketplace-btn-cart" style="width: 48%;">View Cart (0)</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="content-section" style="margin-top: 30px; border: 1px solid #eee; background: #f9f9f9;">
                            <h2>📜 Recent Transactions (Buy/Rent/Sell)</h2>
                            <table class="data-table" id="marketplace-history-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Item</th>
                                        <th>Amount (₹)</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="marketplace-history-body">
                                    <tr><td colspan="5" style="text-align:center; color:#999;">Loading history...</td></tr>
                                </tbody>
                            </table>
                            <button id="show-all-tx-btn" onclick="toggleHistoryView()" class="show-more-btn" style="display:none;">Show All Transactions</button>
                        </div>
                        
                        <h2 style="margin-top: 30px; border-bottom: 2px solid #ccc; padding-bottom: 10px;">🚜 Rent Tractors / Equipment</h2>
                        <p style="font-size:0.9em; color:#666;">Book heavy machinery instantly. Click "Check Availability" to start.</p>
                        
                        <div id="rental-grid-container" class="rental-grid">
                            <p>Loading Rental Equipment...</p>
                        </div>
                    </div>
                    
                {% elif current_page == 'Analytics' %}
                <div class="page-container" id="analytics-view">
                    <h1>📊 Farm Data Dashboard & Analytics</h1>
                    <p style="color: #555;">Data-driven insights for better yield and cost management.</p>

                    <div class="grid grid-cols-3 gap-4 mb-6 mt-5">
                        <div class="bg-green-100 p-4 rounded shadow border border-green-200 text-center">
                            <h3 class="text-green-800 font-bold">Avg Yield</h3>
                            <p class="text-2xl font-bold text-green-600">+12% <span class="text-sm text-gray-500">YoY</span></p>
                        </div>
                        <div class="bg-blue-100 p-4 rounded shadow border border-blue-200 text-center">
                            <h3 class="text-blue-800 font-bold">Resource Efficiency</h3>
                            <p class="text-2xl font-bold text-blue-600">85%</p>
                        </div>
                        <div class="bg-yellow-100 p-4 rounded shadow border border-yellow-200 text-center">
                            <h3 class="text-yellow-800 font-bold">Soil Health Score</h3>
                            <p class="text-2xl font-bold text-yellow-600">7.8/10</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded shadow border">
                            <h3 class="font-bold text-gray-700 mb-4">💰 Financial Performance</h3>
                            <canvas id="yieldChart" height="200"></canvas>
                        </div>
                        <div class="bg-white p-4 rounded shadow border">
                            <h3 class="font-bold text-gray-700 mb-4">💧 Resource Usage (Water)</h3>
                            <canvas id="resourceChart" height="200"></canvas>
                        </div>
                    </div>

                    <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 mt-6 rounded shadow">
                        <h3 class="font-bold text-indigo-800">🤖 AI Insight:</h3>
                        <p id="analytics-ai-text" class="text-indigo-700">Based on historical data, reducing water usage by 10% in Field B saved approx. ₹2,000 this month. Fertilizer costs spike in November—consider bulk purchasing in October.</p>
                    </div>
                </div>

                {% else %}
                    <div class="page-container">
                        <h1>✔ {{ current_page }}</h1>
                        <div class="special-page">
                            <p>Feature Under Development: The **{{ current_page }}** module will be implemented here.</p>
                            <p style="margin-top: 15px; font-size: 0.9em; color: #7f8c8d;">(This demonstrates the scalable, modular structure of the web application.)</p>
                        </div>
                    </div>
                {% endif %}
            </div> 
        </div>
    </div>
</body>
</html>